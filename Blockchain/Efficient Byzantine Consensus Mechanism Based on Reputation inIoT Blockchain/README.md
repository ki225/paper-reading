# Efficient Byzantine Consensus Mechanism Based on Reputation inIoT Blockchain

- https://onlinelibrary.wiley.com/doi/epdf/10.1155/2021/9952218


## 簡介
EBRC (基於信譽的高效拜占庭共識機制) 是一種針對物聯網區塊鏈應用設計的可擴展且基於信譽的共識協議。該協議旨在解決現有物聯網區塊鏈應用中可擴展性差和開銷高的問題。EBRC 通過基於信譽的節點選舉、動態節點加入和退出協議以及優化的共識流程，實現了高共識效率、低網路開銷和高可擴展性

## Introduction

物聯網是一個由各種異構和同質設備組成的系統，廣泛應用於多個領域，但也面臨安全威脅，如 DDoS 和 Sybil 攻擊。區塊鏈作為一種去中心化、防篡改的技術，能夠提升物聯網的安全性，但物聯網區塊鏈面臨存儲、計算和帶寬不足等問題，需要進一步優化吞吐量。

共識機制對物聯網區塊鏈的吞吐量、延遲和容錯能力至關重要。隨著 5G 的出現和物聯網設備數量的增長，區塊鏈架構需要具備更高的吞吐能力來處理大量數據。共識演算法主要分為兩種：基於工作量證明的共識（如 PoW、PoS、DPoS）和基於投票的共識（如 PBFT 和 Tendermint）。未來，混合共識技術將通過結合各自的優勢，提高效率和穩定性。


1. **PBFT共識演算法的問題**：
   - PBFT算法不評估節點的可靠性，可能導致不可靠的節點參與共識。
   - 沒有對惡意節點進行實質懲罰，可能導致惡意攻擊。
   - 在大型物聯網網絡中可能不夠有效，且頻繁的網絡通信會增加高流量開銷。
2. **現有的改進方法**：
   - DBFT：基於代幣選舉共識節點，但會削弱系統的去中心化。
   - EPBFT：使用VRF來篩選共識節點，提高安全性，但對節點可靠性未做詳細評估。
   - Trust-PBFT和T-PBFT：將信任機制結合PBFT，但並未解決PBFT的高複雜度問題。
   - Yuanchao等人提出的方案：根據節點信譽選擇節點，提升安全性，但信譽計算方案不詳。
3. **提出的EBRC共識機制**：
   - 基於**拜占庭信譽**的高效共識機制，適用於大規模和動態的物聯網區塊鏈系統。
   - **四個主要貢獻**：
     1. **信譽機制**：利用物聯網設備的信譽信息和時間戳確保節點可靠性，並使用押金懲罰機制增強安全性。
     2. **VRF隨機選舉機制**：確保選舉節點的公平性和隨機性，並提高系統可擴展性，減少通信複雜度。
     3. **動態加入和退出協議（DJEP）**：幫助系統快速適應新的網絡狀態。
     4. **實驗結果**：在40個節點的實驗中，EBRC表現出較高的共識效率、更高的吞吐量，並減少了通信開銷。




## The Framework of the Agreement
![image](https://hackmd.io/_uploads/BkaO3ZLmJg.png)


#### 2.1 協議概述
適用於物聯網區塊鏈的信譽共識協議EBRC的整體過程框架如圖2所示。EBRC共識協議包括信譽評估、信譽增長率評估、VRF隨機選舉機制、EBRC共識協議本身以及動態加入與退出協議（DJEP）。

![image](https://hackmd.io/_uploads/H1cF2bU7yl.png)

1. 為了確保高質量的共識節點集合，信譽評估演算法根據所有節點組成的區塊節點集中的各種指標來評估節點的信譽和信譽增長率。
2. 通過應用VRF函數，隨機選擇擁有選舉權的節點，以確保選舉的隨機性和公平性。
3. 根據所提出的EBRC共識協議，確保了共識的有效性和可擴展性。
4. 根據DJEP協議，完成了節點在系統中的動態加入和退出，增強了區塊鏈系統的動態性。

#### 2.2 節點評估

EBRC協議中的網絡由N個公共節點組成；每個節點都有一個信譽值和信譽值增長率，這決定了節點是否能成為共識節點。此外，我們假設該網絡是部分同步的，即客戶根據預定格式向網絡提供交易。該網絡也運行於以epoch為主要週期的方式，每個epoch分為20輪，每一輪生成一個區塊。


(i) **節點選舉權**：根據所提出的選舉權表，滿足選舉條件的節點擁有選舉權。
(ii) **共識節點集**：由滿足條件的節點組成的節點集，這些節點具有投票權並通過VRF隨機函數選舉產生。
(iii) **共識節點**：從共識節點集中按比例選出的參與區塊鏈共識的代表性節點集。
(iv) **候選共識節點**：當共識節點失效或節點退出時，快速替換的節點集。
(v) **行為記錄表**：記錄節點信譽、信譽增長率以及信譽參考因素的表格，由整個網絡中的所有節點共同維護。如表1所示，每個節點將創建一個本地元數據池，用來緩存所有節點的行為記錄表，並在每個epoch後更新該表。

#### 2.2.1 信譽模型

信譽模型可以為節點的可靠性提供良好的基礎。
- 通過動態更新節點的信譽值，可以持續減少錯誤節點在共識過程中出現的頻率，確保區塊鏈機制具有高度可訪問性和安全性。
- 共識節點的信譽值可作為獎勳和懲罰的標準，鼓勵節點遵循協議。

信譽值(R)
- 介於 (0,1]
- 代表了對應節點的可信度
- 對於新添加的節點，信譽值設置為 0.5
- 為了成為共識節點，節點必須支付押金，這會影響信譽值的計算。


信譽評估因素如下：

1. **保證金比例**：
    - 節點 \( i \) 的保證金表示為 $d_i$，定義 $D = \sum d_i$ 為區塊鏈網絡中的保證金總和，保證金比例為 $\delta_i = \frac{d_i}{D} \in (0, 1)$。
    - 安全押金設置對惡意行為進行重大經濟處罰，從而降低惡意節點對網絡造成損害的風險。如果節點支付更多的保證金，它參與共識的機會會增加，但同時也會增加其不良行為的處罰。此外，設置保證金門檻以防止某些節點通過賺取大量資金來主導節點提名。
2. **未完成率**：
    - 節點 \( i \) 未能完成共識的次數 \( m_i \) 與節點參與共識的總次數 \( M \) 之比，即 $\tau_i = \frac{m_i}{M} \in (0, 1)$。
    - 未完成率主要衡量節點完成共識的情況。
        - 關鍵因素: 節點由於故障未能完成共識的次數。通過這個指標，可以優先選擇共識完成次數更多的節點，這些節點的狀態較為穩定，從而提高整體共識完成率。
3. **惡意率**：
    - 節點 \( i \) 發送錯誤訊息並成功被報告的次數 \( e_i \) 與節點參與共識的總次數 \( M \) 之比，即 $\Psi_i = \frac{e_i}{M} \in (0, 1)$。
    - 惡意率主要決定節點是否誠實發送訊息。當節點發送錯誤訊息時，其他節點會報告它，該報告可以被系統記錄，直到達成共識協議。
4. **活躍率**：
    - 每個時間段的分類如表2所示。![image](https://hackmd.io/_uploads/Hy26bGLmyg.png)
    - 節點活躍率為：$\phi_i = \frac{(t_i + t_i)}{T_i} \in (0, 1)$。
        - 節點 \( i \) 離線的時間段為 \( t_i \)
        - 節點 \( i \) 網絡延遲的時間段為 \( l_i \)
        - 節點 \( i \) 參與網絡的時間段為 \( T_i \)
    - 活躍率主要衡量節點的活動表現。在拜占庭共識過程中，節點必須相互廣播並等待澄清消息。當低活躍度的節點參與共識時，會造成許多節點等待，導致共識停滯。通過實施這一指標，具有較高活躍度的節點有更大的機會被選中，從而**減少共識延遲**並提高共識成功率。
5. **交易規模因子**：
    - 交易規模因子用來識別節點 \(i\) 的歷史交易處理能力。
        - 假設節點 \(i\) 處理過的交易大小列表為 \(Z_i\)，並且其中的元素從高到低排序為 $c_1, c_2, \dots, c_j$，則交易規模因子 $\rho_i$ 可以表示為：
$$
\rho_i = j, \quad j = c_j, \quad j - 1, \quad j > c_j
$$
    > 這一指標的設計源自於H指數，也叫做H因子。研究者的H指數越高，則他的學術地位越高。節點的總處理能力可以通過測量其在區塊鏈網絡中的交易規模因子來衡量。當現有節點達成一個高交易水平的交易時，這使它們能夠實現更高質量的共識，從而提高交易規模因子得分。

每個參數對整體信譽值的控制程度在計算過程中是不同的。本文重點關注惡意節點的行為評估。因此，在計算上述參數的權重因子時，對節點的未完成率和惡意率賦予最重的權重，其次是其運營率。最後，節點的保證金比例和交易規模因子在信譽值計算中具有相同的權重。

根據以上內容，每個因子的權重定義如下：

$$
W = [0.1, 0.3, 0.3, 0.2, 0.1]
$$

因此，計算信譽值 \( R \) 的公式為：

$$
R_i = 0.1 \delta_i + 0.3 \tau_i + 0.3 \psi_i + 0.2 \phi_i + 0.1 \rho_i
$$

根據上述評價因子，當節點執行惡意行為時，我們可以及時更新該節點的信譽值並執行押金扣減的懲罰機制。

#### 2.2.2. 信譽成長率模型
- 用來確定節點的穩健性。
    - 通過測量信譽成長率，可以評估節點進入區塊鏈網絡後的成長情況，從而使節點能夠合理地行為來維持其信譽成長率。
- 信譽成長率 $Y(t)$ 定義為 (0, 100\%)。
- 新加入區塊鏈系統的節點的信譽值初始化為 50%。根據節點信譽的動態變化，信譽成長率也會相應改變。
- 新信譽成長率公式
    - 計算的是節點自加入系統以來的信譽成長率的平均值。
$$
Y(t) = \frac{R_{i,n} - R_{i,t}}{t - 1} \times 100\%
$$
    - $R_{i,n}$: 節點 \(i\) 在當前回合的信譽值
    $R_{i,t}$: 節點 \(i\) 在前 \(t\) 回合的信譽值。

信譽值和信譽成長率的計算是**基於行為記錄表**進行的。在每一個時期結束前，當前的共識主節點會發起請求，更新信譽值和信譽成長率。具體實現方式見算法 1。在接收到請求後，共識節點根據本地行為記錄緩存池計算整個網絡的新信譽值。接著，它使用本文提出的 EBRC 共識協議達成關於信譽值的共識。共識完成後，主節點將在本回合中信譽值和信譽成長率有變化的節點的信譽更新到行為記錄表中，並將其在整個網絡中廣播。系統隨後進入下一回合的共識選舉階段。

![image](https://hackmd.io/_uploads/r1KQHf87Jl.png)
```
Input: Node set N, Old behavior record table ℤOld
Output: New behavior record table ℤNew

while(ℤold){
    read(ℤold);
    δi = di / D (δi ∈ (0, 1))
    τi = mi / M (τi ∈ (0, 1))
    Ψi = ei / M (Ψi ∈ (0, 1))
    φi = (ti + ti) / Ti (φi ∈ (0, 1))
    ρi = j if j=c_j | = j-1, where j > c_j
    W = [0.1, 0.3, 0.3, 0.2, 0.1]
   h. Calculate Ri = 0.1 * δi + 0.3 * τi + 0.3 * Ψi + 0.2 * φi + 0.1 * ρi
   Y(t) = [(Ri,n / Ri,t) ^ (1 / (t - 1)) - 1] * 100%
   update(ℤOld)   
}
ℤNew = ℤOld
EBRC(ℤNew)  # 這步是用來執行共識協議或進一步處理的佔位步驟
Return ℤNew

```

### 2.3. 節點選舉
擁有不同信譽值和信譽成長率的節點具有不同的選舉權限。為了確保系統的效率和安全性，節點權限與其信譽值和信譽成長率之間的對應關係如表 3 所示。

![image](https://hackmd.io/_uploads/SyrAsf87ye.png)

根據表 3，使用可驗證隨機函數（VRF） 在擁有選舉權限的候選共識節點中隨機抽樣，選擇共識節點集合。根據它們的信譽值排名，將共識節點分為共識節點和候選共識節點。
- 特點
    - 對於特定的隨機數種子輸入 \( S \) 和輸入者的私鑰 \( SK \)，VRF 函數會輸出隨機數 \( L \) 和證明（Proof），並且驗證者通過隨機輸出數字 \( L \)、證明和輸入種子 \( S \) 來驗證隨機數是否正確可靠。
    - 定義 VRF 輸出的隨機數 \( L \) 的閾值 \( $\omega$ \)，規定隨機數 \( L \) 大於或等於閾值的節點可以成為共識節點集合的成員。
        - 閾值: 主要用來調整節點選舉的難度。
- VRF 選舉算法的詳細流程如下：
    - **(i)** 根據先前創建的區塊哈希值，當前的共識主節點將在共識過程的最後一輪使用伪隨機數生成器（PRNG）為每個時期生成隨機數種子 S。然後，當前的共識主節點將 S 添加到區塊鏈中，網絡中的節點將看到該隨機數種子。
    - **(ii)** 節點 A 判斷其是否屬於共識節點集，並計算由 S 使用 VRF 驗證函數生成的隨機數 L 是否小於閾值 ω。如果是，則廣播連接請求並等待剩餘的共識節點在 Δh 內發起連接請求。公式如下：
    $$L = VRF(SK, S)，Proof = VRF_Proof(SK, S)$$
    - **(iii)** 任何接收到連接請求的節點 B 可以根據該節點來證明 Proof 是否有效。如果 Proof 有效，則繼續；否則，終止。公式如下：
$$L2 256 ∈ [0, 1] 且 L ≤ ω，L = VRF_P2H(Proof)$$
    - **(iv)** 節點 B 然後可以驗證節點 A 的公鑰 PK、隨機數種子 S 和 Proof。如果驗證失敗，則可以向整個網絡報告並記錄該節點的行為。如果驗證成功，且節點 B 是共識節點集的成員，則可以向節點 A 發送連接請求以完成連接。相應的公式如下：
    True/False = VRF_Verify(PK, S, Proof)
    - **(v)** 在每個共識節點連接後，根據行為記錄表對節點進行排名。
        - 排名前 50% 的節點為共識節點
        - 排名前 50% 到 85% 的節點為候選節點。
        - 如果共識節點失敗或退出，則由候選節點替換。
            > 需要注意的是，由於 L/2 256 ∈ [0, 1]，並且這裡的選舉算法是概率性的，因此可能會沒有足夠的共識節點來進行交易。此外，根據實驗測試，當節點數量為 10 且 ω = 0.4 時，節點未被選中的概率為 P(0.4) = 0.01%。因此，我們設置 ω = 0.4 以確保節點選擇的隨機性並最小化無選中節點的概率。



### 2.4 EBRC 共識過程
共識過程如圖 3 所示。

![image](https://hackmd.io/_uploads/rJ3eaf8m1g.png)

- P1 是主節點
- R3 是惡意從節點

#### 共識過程如下：

1. 在選擇共識節點後，當前視圖 v 被初始化，並且根據主節點選舉算法選擇當前視圖的共識主節點 p：
    - p = (h + v) mod 3(f + 1)，其中 h 是當前區塊高度，f 是允許故障的最大節點數量。每輪循環中創建一個區塊，視圖編號為 v + 1，並替換主節點。
2. 當交易發起者發起交易時，它使用私鑰簽名該交易，然後將其廣播到整個網絡。消息格式為：
    - <<Crequest, t, d, m(d), c > ,Sigc>
        - t 是時間戳，d 是交易數據，m(d) 是交易數據的摘要，c 是客戶端標識符，Sigc 是客戶端簽名。
3. 節點收到交易後，如果不是共識節點，可以轉發該交易。如果是共識節點，則需要驗證交易的合法性。如果交易有效，節點準備發送準備消息。如果交易非法，則直接丟棄。在主節點發送交易信息後，可以快速啟動視圖替換協議，而無需驗證消息內容。
4. 在 Δt 時間（Δt 是系統內建的等待時間）後，主節點處理請求消息，以確定正在處理的消息是否合法。如果合法，主節點會向從節點廣播共識消息，消息格式為：
    - <<Prepare, h, v, t, d, m(d)> ,Sigp>
        - h 是當前區塊的高度 + 1，v 是視圖編號，Sigp 是主節點 p 的簽名。
5. 當從主節點接收到「準備」訊息後，會對該訊息進行驗證，以確定主節點是否為惡意或發生故障。如果是這樣，則會發起視圖切換請求，並將節點身份記錄在節點行為表中。否則，共識節點會向主節點廣播確認訊息。該訊息格式如下：
    - <<Commit, v, t, m(d), sn, valid/invalid>, Sigi >
        - valid/invalid 表示節點 i 的身份，用於確定該訊息是否有效，Sigi 是主節點 i 的簽名。
6. 當所有共識節點收到 2f + 1 個相同的確認訊息時，就達成共識，並且會執行客戶端的請求，回應客戶端，並寫入區塊，視圖編號更新為 v + 1。否則，會遵循視圖切換協議，並將節點身份報告在節點行為表中。回應訊息的格式如下：
    - <<Reply, c, t, m(d), n, valid/invalid, Sigi >
        - 其中，n 是共識節點的數量，其餘符號解釋如前所定義。

### 2.5. Dynamic Joining and Exiting of Nodes
**DJEP**（動態加入與退出協議）
- 旨在確保當節點離開共識時，系統不會受到影響。如果系統未受影響，則在節點退出或加入後，條件 (n - 1)/3 仍然可以得到滿足。



#### 2.5.1. 動態退出

1. 退出的節點以 <<ERequest, h>, Sigi> 的形式向主節點發送退出請求，其中 h 是區塊高度 + 1，表示節點退出時間（即當區塊高度為 h + 1 時）。  
2. 如果共識節點集的數量在節點退出後少於 3f + 1，則會啟動節點的動態加入階段。否則，主節點和即將退出的節點會發送退出確認訊息，並帶有雙方簽名發送給其他從屬節點。確認訊息的格式如下：  
    - <<Commit, i, h >, Sigi/Sigp >，  
        - 其中 i 是將要退出的節點數量，這個數量是唯一的。

![image](https://hackmd.io/_uploads/rksd0z8QJx.png)


#### 2.5.2. 動態加入

1. 主節點向候選共識節點發送共識節點替換訊息。候選共識節點根據其信譽值進行排名，信譽值最高的候選節點將成為新的共識節點。替換訊息的格式如下：  
    - <<Change, i, h >, Sigp >，  
2. 新的共識節點向主節點和其他從屬節點發送加入請求訊息，格式為：  
    - <<Urequest, i, R, h >, Sigi >，  
        -  R 是將要加入的節點 i 的信譽值。共識節點會查看候選節點的信譽並驗證請求。
3. 當主節點和共識節點驗證並確認此訊息後，他們將廣播“節點加入確認訊息”到共識網絡，這樣共識節點和新的共識節點可以相互確認。該確認訊息的格式如下：  
    - <<Commit, i, h >, Sigi >。

![image](https://hackmd.io/_uploads/rk79AM8Q1g.png)

## 結論
所提出的 EBRC 透過基於信譽的節點選舉和節點的動態加入與退出協議，實現了高共識效率、低網絡開銷和高可擴展性。通過整合 VRF 隨機選舉算法，我們隨機選擇了高信譽的節點加入共識。我們對節點集合中的物聯網設備進行身份認證，使其能夠承擔共識角色。最後，我們進行了大量實驗，結果表明 EBRC 優於傳統的 PBFT 共識機制，並表明我們提出的算法可以為構建物聯網+區塊鏈+網絡法院提供有效的解決方案。
