# Improved Scheme of Practical Byzantine Fault Tolerance Algorithm based on Voting Mechanism


## 簡介
本文優化了 PBFT 演算法，並基於投票機制提出了一種改進方案。該方案使系統中相對誠實的節點形成共識部分，剩餘節點則成為副本節點。在共識過程中，減少了多個階段的通信次數。當主節點發生故障時，可以快速切換節點，提高了系統穩定性。在保證演算法容錯能力的同時，整體通信開銷得以降低，共識延遲和吞吐量也顯著提升。最後，通過實驗驗證了該改進方案的有效性。

## introduction

#### **1. 比特幣與區塊鏈基礎**
- **比特幣誕生**：2008年11月1日，中本聰提出比特幣，基於P2P網路和非對稱加密技術保障交易安全。
- **區塊鏈技術發展**：區塊鏈作為數位貨幣的底層技術，因其潛力和價值而受到廣泛關注。
  
#### **2. 共識演算法**
- **共識演算法的作用**：讓所有節點快速且高效地達成共識，影響整個區塊鏈系統的性能。
- **主流共識演算法**：
  - 工作量證明（PoW）
  - 權益證明（PoS）
  - 委託權益證明（DPoS）
  - 實用拜占庭容錯（PBFT）
- **應用場景**：
  - 公有鏈多用PoW、PoS、DPoS及其變形演算法。
  - 聯盟鏈多用PBFT演算法。

#### **3. PBFT演算法改進**
- **挑戰**：隨節點數量增加，PBFT的通訊開銷和帶寬佔用率大幅提高。
- **改進方案**：基於投票機制的改進方法：
  - 選擇部分誠實節點參與共識。
  - 減少共識節點數量。
  - 降低帶寬佔用與視圖切換頻率。
  - 提升共識效率與區塊鏈系統吞吐量。

#### **4. 區塊鏈類型**
- **公有鏈**：
  - 開放性：完全開放，任何人可加入，數據透明。
  - 典型項目：比特幣。
- **私有鏈**：
  - 開放性：完全封閉，僅內部使用，數據權限由所有者控制。
  - 典型項目：MultiChain。
- **聯盟鏈**：
  - 開放性：半開放，需要許可才能訪問，適合合作組織。
  - 商業價值：相比公有鏈和私有鏈更具商業價值。
  - 典型項目：R3聯盟、原鏈。

#### **5. 關鍵問題與解決方向**
- **性能與擴展性挑戰**：隨節點增加，共識效率降低，通訊成本升高。
- **解決方向**：通過選擇性節點參與及投票機制優化演算法，提升效率並降低資源消耗。 

### 共識演算法比較

1. **PoW（工作量證明）**  
   - 節點透過計算哈希值達成共識，無需額外資訊交換。  
   - 優點：51% 攻擊成本高。  
   - 缺點：依賴算力，浪費能源和硬體資源；吞吐量低。  
2. **PoS（權益證明）**  
   - 以「幣齡」（持幣時間的乘積）為依據分配記帳權，減少算力競爭。 
   - 幣齡大的節點更容易生成區塊。  
   - 解決 PoW 的資源浪費問題。
3. **DPoS（委託權益證明）**  
   - 基於持股投票選出見證節點負責生成和驗證區塊。  
   - 縮短交易確認時間，提升處理效率。  
   - 選舉機制允許股東投票或撤回對節點的信任。  
4. **Paxos 演算法**  
   - 用於分散式系統的消息一致性，應對宕機與容錯問題。  
   - 三角色：  
     - **提案者（Proposer）**：提出提案，發起投票。  
     - **接收者（Acceptor）**：參與投票並存儲值。  
     - **學習者（Learner）**：被動接受投票結果，作為數據備份節點。  
   - 共識階段：  
     - **準備階段**：提案者發送準備消息給多數接收者。  
     - **接受階段**：多數接收者回應後，驗證並接受提案。
5. **Raft 共識協議**  
   - 特點：強領導、領導選舉、成員變更。  
   - 節點角色：  
     - **主節點（Leader）**：處理請求，維持同步。  
     - **候選節點（Candidate）**：參與選舉成為主節點。  
     - **從節點（Follower）**：接收主節點數據，進行同步。  
   - 運作流程：  
     - 主節點透過心跳機制維持領導地位。  
     - 選舉機制確保系統可快速切換主節點，從節點被動同步數據。  
    - 主節點選舉過程
        - 三種可能情況
            - 自己成為主節點。
            - 另一節點成為主節點。
            - 沒有節點成為主節點，進入下一輪選舉。
        - 選舉原則
            - 「先到先得」原則，節點對最先收到的請求進行投票。
            - 候選節點若收到更高任期的主節點心跳信息，將自動降級為從節點。
            - 若選票分散且無法產生主節點，進入下一輪選舉。

### PBFT（Practical Byzantine Fault Tolerance）共識演算法

1. 特點：
   - 解決拜占庭將軍問題，時間複雜度低。
   - 條件：\( n > 3f + 1 \)，其中 \( f \) 是容錯節點數量。
2. 三個子協議：
   - **檢查點協議（Checkpoint Protocol）**：保證系統狀態一致性。
   - **共識協議（Consensus Protocol）**：完成交易確認。
   - **視圖切換協議（View Conversion Protocol）**：替換失效的主節點。
3. 三階段共識流程：
   - **預準備階段（Pre-Prepare）**：
     - 主節點驗證請求並廣播消息給副本節點。
     - 主節點 p 收到來自客戶端 c 的請求消息 <Request, o, t, c>，驗證請求的有效性，將其封裝成 Pre-Prepare 消息並廣播給其他副本節點
         - 消息格式為 <<Pre-Prepare, v, n, d>, m>
             - v：視圖號
             - n：序列號
             - m：消息
             - d：消息摘要
   - **準備階段（Prepare）**：
     - 副本節點(下圖節點 1、2、3 )驗證來自主節點發送的 Pre-Prepare 消息，構造並廣播 Prepare 消息 <Prepare, v, n, d, i>。
         - i 為節點號
     - 收到超過 \( 2f \) 條有效消息後進入下一階段。
   - **提交階段（Commit）**：
     - 所有節點生成並廣播 Commit 消息 <Commit, v, n, d, i> 
     - 若某節點收到超過 \( 2f \) 條有效 Commit 消息，完成共識並向客戶端( c )回覆結果 <Reply, v, t, v, i, r>。
         - t 為時間戳，r 為請求結果
![image](https://hackmd.io/_uploads/Hy2bfWImke.png)
4.  優勢  
    - 保證系統容錯性，即使部分節點失效或作惡。
    - 適用於需要高可靠性與安全性的分佈式系統。


## 本文的改進

PBFT 演算法主要應用於聯盟鏈，雖具有 **高可靠性、低延遲及高吞吐量** 等優勢，但也存在一些缺點：  
1. **缺點**：
   - 共識協議過程複雜，佔用大量網絡頻寬。
   - 通訊的時間複雜度達到 \( O(n^2) \)。  

2. **改進方案**：
   - **篩選共識節點集**：基於節點的誠信度，系統通過投票選出相對誠實的節點作為共識節點，其餘作為記帳節點。
   - **優化消息傳遞過程**：主節點只向共識節點及記帳節點發送 Commit 消息，共識節點回覆 Reply 消息給客戶端，有效降低網絡開銷。

---

### A. 改進方案的整體流程  

1. **改進方法**：
   - 修改原 PBFT 演算法，在共識執行前，篩選出誠實的共識節點集。
   - **共識節點**：至少 4 個，負責執行共識協議。
   - **記帳節點**：負責保存新的區塊。
2. **流程細節**：
   - **步驟 1**：所有節點投票選出共識節點和記帳節點，根據系統節點總數及運行狀態動態調整共識節點數量。  
   - **步驟 2**：在共識節點集中，得票數最多的節點作為主節點 \( p \)，負責接收客戶端的交易請求並生成新區塊。  
   - **步驟 3**：主節點 \( p \) 收到交易請求後，驗證請求並生成 Pre-Prepare 消息，進行簽名並廣播，將交易保存至日誌文件。  
   - **步驟 4**：共識節點接收到主節點的消息後，檢查簽名並通過驗證，生成 Prepare 消息進行簽名，回覆給主節點並記錄消息。  
   - **步驟 5**：主節點收集共識節點的 Prepare 消息，若驗證通過的消息數量至少為 \( 2f \)，生成 Commit 消息廣播至網絡，進入 Commit 階段，更新區塊鏈並回覆客戶端。記帳節點更新本地區塊鏈高度。  
   - **步驟 6**：客戶端接收共識節點回覆的 Reply 消息，當收到至少 \( 2f \) 條消息時，達成共識，結束本輪共識。  


### 改進優勢  
- 篩選誠實節點減少惡意節點干擾，提升可靠性。
- 優化消息傳遞，降低網絡負擔，提升效率。
- 支援動態調整節點數量，增加系統靈活性和適應性。

> 經過多輪共識後，仍有一定的概率在共識過程中因以下原因導致請求逾時：主節點故障、網絡問題或不可抗力因素。此時，主節點會被認定為惡意節點，觸發協議切換以解決主節點的惡意行為問題。由於引入了投票機制，改進方案的視圖轉換協議提高了誠實節點成為主節點的可能性，降低了視圖轉換協議的啟用概率和通信開銷。


### **B. 視圖轉換協議**  
共識節點需要在相同的視圖下執行共識協議。當出現以下情況時，視圖轉換協議負責確保系統正常運行：  
1. **主節點故障**  
2. **請求逾時**  
3. **在限定時間內未生成新區塊**  

在傳統 PBFT 協議中，視圖轉換協議包括三個步驟：  
1. **增加視圖編號**：  
   副本節點將視圖編號加 1，並廣播視圖更改消息（View Change Message）。  

2. **接收足夠多的視圖更改消息**：  
   副本節點至少需要接收 \( 2f \) 條視圖更改消息，表示多數節點同意進行視圖轉換。  

3. **新主節點確認**：  
   新的主節點接收確認消息（Ack Message），完成切換後，系統進入新視圖，繼續運行。  

### 改進優勢  
- **誠實節點優先**：增加誠實節點成為主節點的機會，提升系統穩定性。  
- **減少視圖切換次數**：有效降低視圖轉換協議的啟用頻率。  
- **降低通信負擔**：減少運行視圖轉換協議時的通信開銷，提升效率。  


