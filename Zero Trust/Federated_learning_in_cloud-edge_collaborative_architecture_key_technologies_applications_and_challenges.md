# 文章閱讀: Federated learning in cloud-edge collaborative architecture: key technologies, applications and challenges

- 作者: Guanming Bao and Ping Guo
- 時間: 15 December 2022
- 文章連結: https://journalofcloudcomputing.springeropen.com/articles/10.1186/s13677-022-00377-4


本文介紹了傳統與新興 FL 模型，並總結了在雲邊協作架構中部署聯邦學習的關鍵技術、應用和挑戰，為初入雲端與聯邦學習領域者整理充足的背景知識，並給予了很多思考方向。

## 雲端邊緣協作架構
### 邊緣運算
- 介紹
    - 「邊緣」指的是從原始數據到雲端伺服器的路徑上的任何計算和通信資源。
    - 邊緣計算將部分計算任務從雲端轉移到邊緣伺服器，這提高了通信效率
- 架構
    - 雲端計算中心、邊緣伺服器和物聯網設備
- 在物聯網中的考量
    - 程式遷移：邊緣節點通常有不同的 OS，使得某些邊緣設備上的程式在轉移到邊緣伺服器時可能無法正確運行或無法運行。
    - 安全性：邊緣設備的資源不足以支持大規模的傳統隱私方法，例如同態加密（HE）。另一方面，一些邊緣節點和客戶端可能由於管理鬆散而成為惡意攻擊者，這可能會破壞聯合模型的準確性。
    - 服務連續性
        - 通常邊緣設備連接到地理位置較近的邊緣伺服器。
        - 然而，某些場景如車載網絡，邊緣設備可能會移動到靠近另一個邊緣伺服器的地方並連接到新的伺服器。在這一動態過程中保持服務連續性是一個挑戰。
    

### 雲端邊緣協作
由於物聯網中的數據通常不是一次性的，預處理過的數據仍然需要從邊緣伺服器收集到中央雲端伺服器中。
- 架構
    - 邊緣計算（EC）
        - 處理具有高實時要求的數據。
    - 雲端計算
        - 處理非實時和長期數據，進行邊緣應用的管理，提供數據備份和大數據分析等服務。
- 雲端和邊緣計算的三種基本模型
    - IaaS（Infrastructure as a Service，基礎設施即服務）
        - 提供原本本地部署的基礎設施服務，包括網絡、計算和存儲硬件以及虛擬機。同時，IaaS提供商還提供一系列附加的基礎設施服務，如實時計費、監控、日誌採集、防火牆和安全協議、備份和恢復等。IaaS為各種組織提供了極大的便利，因為當組織需要開發新產品時，他們可以不必擔心構建具體的基礎設施，而是直接從IaaS提供商那裡購買或租用相應的資源。
    - PaaS（Platform as a Service，平台即服務）
        - PaaS不僅包括基礎設施硬件設施，還提供基於基礎設施的軟件服務，包括操作系統、數據庫等中間件。其他PaaS服務包括應用設計和開發、應用測試和部署、網絡服務整合、信息安全和數據庫整合。
    - SaaS（Software as a Service，軟件即服務）
        - 是一種軟體分發模型，提供商托管應用程序並通過互聯網向最終用戶提供這些應用程序
        - 通常面向B2B和B2C用戶。用戶不需要關心他們需要的工作環境，包括應用程序和系統軟件的安裝，這些都包含在SaaS中。

![image](https://hackmd.io/_uploads/ByDYW2c3A.png =400x)

## P2P協作架構
邊緣節點也可以彼此協作，構成點對點（P2P）協作架構。

P2P網路模型可以分為集中式P2P和分散式P2P。
- 集中式P2P模型
    - 部署一個或多個雲端伺服器來記錄資源在對等節點之間的動態狀態
- 分散式P2P
    - 一個純粹的對等節點網路，每個節點具有相等的權限。

本文應參考集中式P2P，其中每個邊緣節點不僅可以與雲端伺服器協作，也可以與其他附近的邊緣節點協作。引入去中心化的P2P網絡到邊緣伺服器中，可以使協作架構更加穩健，因為P2P減輕了雲端邊緣架構中的單點故障問題，使架構在邊緣節點移動時更加靈活和穩健。本文將探討P2P網絡在雲端邊緣協作架構中的一些應用。

## 聯邦學習
### 介紹
:::spoiler FedAvg
#### Federated Averaging, FedAvg
- 第一個聯邦演算法
- 三步驟(迭代步驟2和3)
    - 初始化：全局模型和本地模型的參數被初始化為相同的值。
    - 本地更新：隨機選擇一定數量的客戶端。每個選中的客戶端在其本地數據上執行梯度下降。
    - 全局更新：全局模型的參數更新為所有本地模型更新的加權平均值。
:::
- 目的
    - 處理數據孤島問題
    - 比傳統的集中式機器學習更安全
- 分類
    1. 水平聯邦學習（Horizontal Federated Learning, HFL）
        - 適用於樣本之間的聯合，當大多數特徵重疊而少數樣本重疊時，例如在不同地區的醫院之間共享診斷數據以訓練更穩健的模型來進行準確診斷。
    2. 垂直聯邦學習（Vertical Federated Learning, VFL）
        - 適用於樣本重疊較多而特徵重疊較少的情況，例如，銀行和互聯網公司共享數據來建模客戶信用以進行風險控制。
    3. 聯邦轉移學習（Federated Transfer Learning, FTL）
        - 適用於樣本重疊較多而特徵重疊較少的情況，例如，銀行和互聯網公司共享數據來建模客戶信用以進行風險控制。
- 挑戰
    - 統計異質性
        - 可用的本地數據無法代表整體分佈。
        - 主要挑戰
    - 系統異質性
        - 參與聯邦學習的客戶端通常具有不同的硬件條件，如網絡、電池、計算能力和存儲容量。一些設備可能因為資源限制而無法及時返回本地更新，而大多數聯邦學習設定是同步的，這可能會延長收斂時間。
    - 模型異質性
        - 通常發生在商業對商業（B2B）聯邦學習中，其中不同的客戶可能對模型有不同的要求，由於他們的期望不同，但在FL中每個客戶只提供一個全局模型，對所有客戶都能有良好的預測性能是一個挑戰。此外，大多數先前的FL算法假設客戶是誠實的，這帶來了安全風險。

:::spoiler Statistical heterogeneity 統計異質性
### Statistical heterogeneity 統計異質性
聯邦學習面臨的主要挑戰: 可用的本地數據無法代表整體分佈。假設有一個訓練任務，包括特徵 \(x\) 和標籤 \(y\)。客戶端 \(i\) 的本地數據分佈可以描述為 \(P(x, y)\)。不同學習任務中的非獨立同分佈（Non-iid）形式有很多種：
- **特徵分佈偏差（協變偏移）**：邊際分佈 \(P(x)\) 在不同客戶端之間變化。例如，在語音識別中，不同人說出的相同語音內容在音質和語調上可能有所不同 [37]。
- **標籤分佈偏差（先驗概率偏移）**：邊際分佈 \(P(y)\) 在客戶端之間有所不同。在不同使用環境中，相同的特徵可能會生成多個標籤。
- **相同標籤對應於不同特徵（概念漂移）**：條件分佈 \(P(x|y)\) 變化。在特定客戶端的某一時間或地點，相似的特徵可能對應於多個標籤。
- **相同特徵對應於不同標籤（概念轉移）**：條件分佈 \(P(y|x)\) 不同。例如，在Gboard中，相同的詞語“我想要”對用戶A來說會預測為“去睡覺”，而對用戶B則預測為“喝點東西”。
- **數量偏差或不平衡**：參與聯邦學習的參與者可能從一個智能手錶到一個醫院不等，數據量差異很大。

為了衡量非IID，Li等人提出了通過全局目標函數和本地目標函數的和來評估非IID程度的方法，這與非IID程度有正相關。大量研究已經在統計異質性方面對FL進行了優化，並取得了優秀的結果。
> McMahan等人表明，FedAvg 在非IID數據上表現良好，但許多研究發現，推導出的模型在非IID數據上的精度會顯著下降。
:::

### edge federated learning 邊緣聯邦學習
- 在雲端邊緣協作架構中，聯邦學習（FL）可以通過雲端和邊緣的協作來進行優化
- 基本元素
    - 邊緣設備：邊緣設備通常是分佈在網絡邊緣的可攜式設備，例如智能手機、智能手錶和平板電腦。由於便攜性，它們通常配備相對有限的計算和存儲資源，這意味著它們不適合執行大規模的計算任務。這些設備收集並存儲大量用戶生成的數據，這些數據通常包含用戶的隱私。
    - 邊緣伺服器：邊緣伺服器通常靠近邊緣設備，通信鏈路較短，帶寬資源相對豐富，因此邊緣伺服器與邊緣設備之間的通信速度快且高效。邊緣伺服器通常擁有比邊緣設備更豐富的計算和存儲資源，並且電源供應更穩定。它們有望分擔邊緣設備的計算任務並擴展其能力。
    - 雲端伺服器：雲端計算中心地理位置遠離邊緣設備和邊緣伺服器，通信速度較慢且帶寬有限。運營商為中央伺服器提供了大量的存儲資源和強大的計算能力，適合進行大規模的計算任務。
- 特色: 雲端伺服器首先將原始的全局模型分發給邊緣伺服器，邊緣設備則向指派的邊緣伺服器請求下載初始模型參數。同樣，邊緣聯邦學習允許在邊緣設備上的本地模型輸出首先在邊緣伺服器上進行聚合，經過幾輪迭代後，邊緣伺服器和中央伺服器之間進行全局聚合。當模型收斂到設定的準確度時，中央伺服器會通過邊緣伺服器將全局模型參數分發給邊緣設備。

###  federation 種類
- 跨設備聯邦學習（cross-device FL）
    - 通常應用於大量物聯網設備之間的學習，以提高質量服務（QoS），例如拼寫預測
    - 大規模的客戶端 -> 通信瓶頸和高併發等挑戰
- 跨孤島聯邦學習（cross-silo FL）
    - 常用於大型機構之間的訓練，以最大化預測準確性，例如多個醫療機構之間合作訓練具有更高準確度的疾病預測模型。
    - 涉及的客戶端數量少得多，每個客戶端保留大量樣本，要求客戶端進行更多的計算

![截圖 2024-09-08 下午2.16.37](https://hackmd.io/_uploads/ryVI-a5nR.png)

### 基於雲邊協作的跨設備聯邦學習

與傳統的跨設備聯邦學習相比，基於雲邊協作的跨設備聯邦學習可以進一步改進。通過部署邊緣伺服器，邊緣網絡可以保護邊緣流量，遭受攻擊的邊緣伺服器可以從訓練中撤回，這樣，受邊緣節點管理的本地訓練中的攻擊將不會影響其他本地訓練 [43]。除了安全增強之外，客戶端執行的本地計算任務可以安全地卸載到邊緣伺服器 [44]，這可以為移動設備提供低延遲的計算服務，只要客戶端和邊緣伺服器之間有足夠的通信帶寬，從而減少參與訓練的客戶端的計算量。

### 基於雲邊協作的跨孤島聯邦學習

在雲邊協作架構中，跨孤島聯邦學習有更多的可能性。在跨孤島聯邦學習中，每個客戶端的本地數據集更適合被視為單獨的學習任務，而不是數據片段的集合，當孤島之間的數據分佈差異很大時，會出現嚴重的非獨立同分佈（Non-IID）問題。在傳統的雲計算架構中，元學習和轉移學習 [45] 常被用來解決非獨立同分佈問題。雲邊協作架構提供了一種解決非獨立同分佈的新方法，即基於聚類的分層聯邦學習。設計基於集群的方法最簡單的方法是根據數據分佈劃分客戶端，將具有相似數據分佈的客戶端放在同一學習任務中，並通過邊緣伺服器進行管理 [46]。Beiggs 等 [47] 確認這種方法在解決非獨立同分佈問題方面是有效的。

### 分裂學習（Split Learning，SL）/ 分裂神經網絡（SplitNN）

- 分佈式和私密的深度學習技術
- 特色
    - 提升計算資源效率和減少通信成本方面具有很大潛力
    - 通過多個數據客戶端和一個中央伺服器訓練深度神經網絡。SL 可以滿足以下要求：
    （i）數據客戶端不希望其本地敏感數據被其他客戶端或中央伺服器看到
    （ii）中央伺服器可以保留一些網絡參數以進行推斷
    （iii）中央伺服器可以控制訓練的整體架構。
    - 由於其基於轉發的訓練過程，SL 的速度較慢
- 實作
    - 深度神經網絡被分為多個部分，每個部分在不同的數據客戶端上進行訓練。
    - cut layer
        - 每個客戶端將深度神經網絡的一部分訓練到相同的層
        - 切割層的輸出會被傳送給其他客戶端，而不是原始的敏感數據。
    - 通過有序地轉發前向傳播，完成其餘的前向傳播。
    - 前向傳播後，梯度以類似的方式從最後一層回傳到切割層，只有在客戶端的切割層上的梯度被轉送到中央伺服器，其餘的反向傳播則在中央伺服器中完成。
    - 上述過程將繼續進行，直到分裂神經網絡訓練完成，這是 SL 的最簡單配置。

#### U-shaped SL
- 補償標籤不夠私密的問題
- 在終層，中央伺服器中的深度網絡被包裹起來，並將輸出轉發給數據客戶端，客戶端計算梯度並進行反向傳播，而無需交換標籤。
#### Vertical SL 
- 與垂直聯邦學習（VFL）類似，VSL 適用於數據樣本重疊較多而特徵重疊較少的場景。
- 兩者首先將不同的部分模型訓練到切割層，然後將兩個切割層的輸出結合並轉送給中央伺服器進行其餘的訓練。然後重複這一過程直到收斂。

## 將聯邦學習應用於雲端邊緣協作架構的關鍵技術
在雲端邊緣協作架構中部署聯邦學習的三項關鍵技術，即通信、隱私與安全，以及個性化。

### 通信
:::spoiler 通信


#### End computing
- 背景
（i）移動設備的計算能力不斷提高
（ii）客戶端中的數據相對較小，移動設備被認為能夠執行更多的本地計算
（iii）與計算資源相比，用戶更傾向於重視通信資源，例如，用戶只有在連接到 WiFi 時才參與 FL。
- 目的: 使 FL 客戶端執行更多的本地計算，並在全局更新之前由邊緣伺服器進行更多的邊緣聚合，加快模型的收斂速度，從而減少整體通信輪次。
- 相關研究
    - 增加邊緣設備上的梯度下降次數
    - 增加並行性以涉及更多的客戶端進行訓練
    > 然而，考慮到計算增加的限制，計算和通信之間的最佳折衷是需要解決的問題。在其他研究的實驗中，基於符合 IID 分佈的數據集的模擬顯示：（i）增加客戶端上的計算量可以將通信輪次減少超過 30 倍。（ii）增加並行性對通信輪次的減少有一個閾值，超過該閾值後，通信輪次幾乎不會再減少。
#### Aggregation control 聚合控制
- 說明
    - 通過控制聚合頻率和參與設備數量來減少通信次數。
- 相關研究
    - 分佈式 ADAM 優化以調整 FedAvg
        - 為了減少收斂所需的迭代次數，研究者探索了新型壓縮技術並提出了一種通信高效的 FedAvg 變體，他們聲稱這可以將通信成本降低到 FedAvg 的六分之一。
    - 新的通信協議 FedCPF。
        - 該方法分配部分客戶端參與通信，以避免主要的並發問題，並限制每輪的通信時間，提供了一種靈活的解決方案
    - 異步聚合以避免因客戶端滯後造成的通信低效。

#### 模型壓縮
- 說明
    - 利用量化、稀疏和低秩近似等方法來壓縮客戶端需要上傳的模型，可以提高通信效率，但會造成訊息不精確
- 相關研究
    - 針對 FL 的梯度三元壓縮
    - 編碼梯度向量所需的位數和壓縮誤差之間的折衷
:::

### 隱私與安全
:::spoiler 隱私
FL 攻擊方式
（i）成員推斷：攻擊者判斷某個樣本是否在訓練集中。
（ii）屬性推斷：攻擊方判斷某個樣本屬性是否參與了訓練。
（iii）特徵推斷：通過觀察惡意安排的客戶端信息來恢復目標樣本的原始數據。


保護策略
1. 差分隱私（Differential Privacy，DP）
    - DP通過在聚合之前向客戶端的參數中添加人工噪聲
    - 缺點
        - DP在客戶端規模相對較小時提供的保護水平較低
        - 可能會導致數據丟失問題，因為接收者也無法解密噪聲
2. 同態加密（Homomorphic Encryption，HE）
    - 保證更新的梯度在泄漏時無法被攻擊者解密
    - 缺點
        - 極其低效的通訊
        - HE通常涉及大量模塊乘法計算和大型指數運算，消耗了原本用于本地訓練的計算資源，對於跨設備FL尤其低效
:::

:::spoiler 安全
FL的設計目的是保護客戶端訓練數據的機密性，這意味著聚合器（邊緣伺服器或雲端伺服器）無法知道上傳向量的生成方式，因此FL容易受到上傳惡意向量的攻擊。
（i）數據中毒攻擊：安排一些惡意客戶端參與FL，並提供大量標籤錯誤的數據。
（ii）模型中毒攻擊更具破壞性。惡意參與者可以通過模型替換將後門功能引入聯合模型。

針對這兩種中毒攻擊，兩種有效的防禦方法：
（i）整體失效：對於每個參與者的更新，聚合器檢查該更新是否能改善聯合模型的性能。如果全局模型性能下降，該客戶端會被標記為可能的惡意參與者，並且當多輪更新發現削弱聯合模型時，聚合器會將該客戶端識別為攻擊者。
（ii）客戶端差異：攻擊者的目標通常是使全局模型對一組高度集中錯誤標記的數據樣本進行分類，因此攻擊者也可以通過明智地比較任意兩個客戶端的模型大小來確定。當模型更新幅度很大時，該客戶端很可能是攻擊者，經過多輪觀察後，聚合器可以篩選出大部分攻擊者。
:::

### 個性化
模型異質性指的是不同客戶可能對模型有不同的需求，例如，在一個文字預測任務中，輸入相同的「I like ......」，不同的客戶顯然會期望不同的預測結果。可以通過一些個性化的方法來在一定程度上解決模型異質性問題。

- 適用於雲邊協作架構的個性化聯邦學習（PFL）
    - Meta-Learning
        - 隨著任務數量的增加，找到動態搜索最佳學習策略的方法。
        - 將元學習應用於聯邦學習中，以增強模型的泛化性能。
    - Transfer Learning
        - 系統能夠識別並應用在先前任務中學到的知識和技能於新領域或任務
        - 在聯邦學習中，數據質量不足的情況普遍存在，遷移學習的引入可以改善模型的個性化性能。
