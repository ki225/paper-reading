# æ–‡ç« é–±è®€ â€”â€” BLUFFS: Bluetooth Forward and Future Secrecy Attacks and Defenses

- ä½œè€…ï¼šDaniele Antonioli
- å‡ºç‰ˆï¼š2023
- æ–‡ç« ä¾†æºï¼šhttps://francozappa.github.io/publication/2023/bluffs/paper.pdf
- é—œéµå­—ï¼šBluetooth, forward secrecy, future secrecy, attacks, defenses

---
# introduction
## è—ç‰™çš„å®‰å…¨æ€§å’Œéš±ç§çš„åŸºç¤
è—ç‰™çš„å®‰å…¨æ€§å’Œéš±ç§å–æ±ºæ–¼é…å° (pairing) å’Œ æœƒè©±å»ºç«‹(session establishment)ï¼Œè€Œé€™å…©ç¨®æ©Ÿåˆ¶è¢«å®šç¾©æ–¼è—ç‰™è¦ç¯„ä¸­ã€‚å› æ­¤ï¼Œè‹¥å…©è€…ä¸­å­˜åœ¨æ¼æ´ï¼Œå°±æœƒæˆç‚ºæœ‰å¿ƒäººå£«çš„æ”»æ“Šé¢ï¼Œå› ç‚ºé€™å€‹æ¼æ´æœƒé©ç”¨æ‰€æœ‰ç¬¦åˆè©²è—ç‰™æ¨™æº–è¦ç¯„ä¸‹çš„è£ç½®ã€‚

é…å°æ¶‰åŠä½¿ç”¨è€…äº’å‹•ï¼Œé€éæŒ‰ä¸‹æŒ‰éˆ•ã€æ•¸å­—é…å°ç­‰æ–¹å¼å®Œæˆé…å°ï¼Œé…å°æˆåŠŸå³ç”¢ç”Ÿåç‚º pairing key çš„é•·æœŸå¯†é‘°(long-term secret)ã€‚è‡³æ–¼å¾ŒçºŒå¦‚ä½•ä¿è­·ä½¿ç”¨è€…çš„å°è©±å…§å®¹ï¼Œå°±è¦é€é session establishment ä¸­æ–°çš„ session key ä¾†æ›¿é€™å€‹å°è©±éç¨‹é€²è¡ŒåŠ å¯†ã€å»ºç«‹å®Œæ•´çš„ä¿è­·ï¼Œå…¶ä¸­ï¼Œæ¯å€‹æ–°çš„ session key æ˜¯é€ééœæ…‹çš„ pairing key (é…å°æ™‚ç¢ºå®š) å’Œå‹•æ…‹çš„è®Šæ•¸ (runtime parameters / key diversifiers)ä¾†æ±ºå®šã€‚

> è«–æ–‡è£¡æåŠ session key æ˜¯ç”¨ fresh session key è¡¨ç¤ºã€‚

ç„¡è«–æ˜¯é…å°é‚„æ˜¯å°è©±å»ºç«‹ï¼Œéƒ½ä½¿ç”¨é€™å…©ç¨®å®‰å…¨æ©Ÿåˆ¶ï¼š

-  å‚³çµ±å®‰å…¨é€£æ¥ (Legacy Secure Connections / LSC) ä½¿ç”¨å‚³çµ±åŠ å¯†åŸèªå’Œéç¨‹ (cryptographic primitives and procedures) 
-  å®‰å…¨é€£æ¥ (Secure Connections / SC) ä½¿ç”¨ç¬¦åˆ FIPS (Federal Information Processing Standardsï¼Œè¯é‚¦è³‡è¨Šè™•ç†æ¨™æº–) çš„æ–¹å¼ï¼Œä¾‹å¦‚ï¼š ECDH, AES-CCM.
> 1. ECDHï¼ˆElliptic Curve Diffie-Hellmanï¼‰ï¼šECDH æ˜¯ä¸€ç¨®åŸºæ–¼æ©¢åœ“æ›²ç·šçš„éå°ç¨±å¯†é‘°å”å•†ç®—æ³•ï¼Œç”¨æ–¼å®‰å…¨åœ°å”å•†å¯†é‘°ä¸¦ç¢ºä¿é€šè¨Šçš„å®‰å…¨æ€§ã€‚ECDH æä¾›äº†é«˜å¼·åº¦çš„å¯†é‘°å”å•†åŠŸèƒ½ï¼ŒåŒæ™‚å…·æœ‰è¼ƒå°çš„å¯†é‘°å°ºå¯¸å’Œå¿«é€Ÿçš„é‹ç®—é€Ÿåº¦ï¼Œå› æ­¤å»£æ³›æ‡‰ç”¨æ–¼å®‰å…¨é€šè¨Šä¸­ã€‚
>2. AES-CCMï¼ˆAdvanced Encryption Standard - Counter with CBC-MACï¼‰ï¼šAES-CCM æ˜¯ä¸€ç¨®çµåˆäº† AES å°ç¨±åŠ å¯†å’Œ CBC-MACï¼ˆCipher Block Chaining - Message Authentication Codeï¼‰çš„åŠ å¯†æ¨¡å¼ï¼Œç”¨æ–¼åŒæ™‚å¯¦ç¾åŠ å¯†å’Œæ¶ˆæ¯å®Œæ•´æ€§é©—è­‰ã€‚

## ç ”ç©¶èƒŒæ™¯
EURECOM çš„å­¸è€…åœ¨ç ”ç©¶è—ç‰™æ¨™æº–çš„éç¨‹ä¸­ï¼Œæ¨æ–·å‡ºè—ç‰™çš„å‰å‘ä¿å¯†æ€§å’Œæœªä¾†ä¿å¯†æ€§ï¼šã€Œ**å¦‚æœé…å°é‡‘é‘°ä¿æŒç§˜å¯†ï¼Œè—ç‰™æ‡‰è©²åœ¨æœƒè©±ä¹‹é–“æä¾›å‰å‘å’Œæœªä¾†çš„ä¿å¯†æ€§**ã€ï¼Œé€™ä¹Ÿå°±ä»£è¡¨ï¼Œå³ä¾¿æ”»æ“Šè€…ç ´å£ç•¶å‰çš„æœƒè©±é‡‘é‘°ï¼Œä»ä¸èƒ½å¤ è§£å¯†ä¾†è‡ªéå»å’Œæœªä¾†çš„æœƒè©±å…§å®¹ã€‚ä½†å­¸è€…ä»å°é€™å€‹å‡è¨­æå‡ºç–‘å•ï¼šã€Œé€éåœ¨å”è­°ç´šåˆ¥æ‚„æ‚„æ”»æ“Šæœƒè©±é‡‘é‘°çš„ç”Ÿæˆï¼Œå³ä½¿ä¸çŸ¥é“ pairing key æˆ–è§¸ç™¼æ–°çš„é…å°äº‹ä»¶ï¼Œæœƒè©±çš„å‰å‘å’Œæœªä¾†ä¿å¯†æ€§ä»å¯èƒ½è¢«ç ´å£ã€ã€‚

æœ¬ç¯‡æ–‡ç« å°‡æœƒé€éæ¢è¨é€™å€‹ç–‘å•ï¼Œèªªæ˜ä»€éº¼æ˜¯ BLUFFS æ”»æ“Šï¼Œä»¥åŠå…§éƒ¨çš„åŸç†ã€‚

## BLUFFS æ”»æ“Šçš„ç°¡ä»‹
BLUFFS æ”»æ“Šï¼Œæ˜¯å…­ç¨®æ–°å‹æ”»æ“Šï¼Œé‡å°æœƒè©±å»ºç«‹ä¾†ç ´å£è—ç‰™çš„å‰å‘å’Œæœªä¾†ä¿å¯†æ€§ï¼Œä½¿ç”¨çš„æ–¹æ³•æ˜¯**å¼·åˆ¶ä½¿ç”¨å‚³çµ±å®‰å…¨é€£æ¥**ï¼ˆLSCï¼‰æœƒè©±å»ºç«‹ï¼Œä¸¦ä»¥æ–°ç©çš„æ–¹å¼æ“æ§å…¶ç”¢ç”Ÿé‡‘é‘°ï¼Œä»¥åœ¨æœƒè©±ä¹‹é–“é‡è¤‡ä½¿ç”¨æ”»æ“Šè€…å·²çŸ¥çš„é‡‘é‘°ã€‚

æ”»æ“Šè€…é¦–å…ˆå®‰è£ä¸€å€‹å¼±æœƒè©±é‡‘é‘°ï¼Œç„¶å¾ŒèŠ±ä¸€äº›æ™‚é–“å°å…¶é€²è¡Œæš´åŠ›ç ´è§£ï¼Œä¸¦åœ¨å¾ŒçºŒæœƒè©±ä¸­é‡è¤‡ä½¿ç”¨å®ƒä¾†å†’å……æˆ–é€²è¡Œä¸­é–“äººæ”»æ“Šï¼ˆMitMï¼‰å—å®³è€…ï¼ˆç ´å£æœªä¾†ä¿å¯†æ€§ï¼‰ï¼Œä¸¦è§£å¯†éå»æœƒè©±çš„æ•¸æ“šï¼ˆç ´å£å‰å‘ä¿å¯†æ€§ï¼‰ã€‚

## ç ”ç©¶çµæœ
é€éè©•ä¼°åµŒå…¥äº†åä¸ƒç¨®ç¨ç‰¹è—ç‰™èŠ¯ç‰‡çš„åå…«å€‹è¨­å‚™ï¼Œç™¼ç¾äº† BLUFFS æ”»æ“Šå°ç”Ÿæ´»ä¸­è£ç½®çš„å½±éŸ¿è¦æ¨¡ç”šå¤§ã€‚æœ€çµ‚ç ”ç©¶è€…æå‡ºå¯å¢å¼·çš„è—ç‰™æœƒè©±é‡‘é‘°è¡ç”Ÿå‡½æ•¸ï¼Œå®ƒé‡è¤‡ä½¿ç”¨æ¨™æº–å…¼å®¹çš„åŠ å¯†åŸèªï¼ˆå³ğ‘’1å’Œğ‘’3ï¼‰å’Œéˆè·¯å±¤å‡½æ•¸ï¼ˆå³LMPå‘½ä»¤ï¼‰ã€‚å¦å¤–ï¼Œå®ƒéœ€è¦é¡å¤–çš„å››åå…«ï¼ˆ48ï¼‰å€‹å­—ç¯€çš„ç„¡ç·šå‚³è¼¸å’Œä¸‰å€‹é¡å¤–çš„å‡½æ•¸èª¿ç”¨ã€‚

# åŸºæœ¬æ¦‚å¿µ
## è—ç‰™
è—ç‰™æ˜¯ä½åŠŸè€—å’Œå¯é çš„ç„¡ç·šé€šä¿¡çš„äº‹å¯¦ä¸Šæ¨™æº–æŠ€è¡“ï¼Œæœ€åˆä½œç‚ºç„¡ç·š2.4 GHz ISMï¼ˆå·¥æ¥­ã€ç§‘å­¸å’Œé†«ç™‚ï¼‰é »æ®µçš„ä¸€ç¨®æ›¿ä»£æœ‰ç·šå‚³è¼¸å”è­°è€Œèª•ç”Ÿã€‚ç”±æ–¼è—ç‰™å‚³è¼¸æ•æ„Ÿæ•¸æ“šå’Œå‘½ä»¤ï¼Œå› æ­¤è—ç‰™å°åŒ…æ‡‰è©²å—åˆ°é˜²æ­¢è¨­å‚™æ¬ºé¨™å’Œä¸­é–“äººæ”»æ“Šç­‰ç›¸é—œæ”»æ“Šçš„ä¿è­·ã€‚

è—ç‰™ stack å¤§è‡´éµå¾ª OSI æ¨¡å‹ã€‚åœ¨ç‰©ç†å±¤ï¼Œå®ƒä½¿ç”¨åŒæ­¥è·³é » (synchronized frequency hopping) å’Œæ™‚åˆ†å¤šå€ (time division multiple access)ã€‚éˆè·¯å±¤ (link layer) ä½¿ç”¨ç”± link manager protocolï¼ˆLMPï¼‰ç®¡ç†çš„æ˜Ÿå‹æ‹“æ’² (star topology)ã€‚éˆè·¯å±¤çš„é€£æ¥ç™¼èµ·è€…ç¨±ç‚º centralï¼Œè€Œå›æ‡‰è€…å‰‡ç¨±ç‚º Peripheralï¼Œå…©è€…å¯ä»¥åœ¨ connection å»ºç«‹æœŸé–“æˆ–é€£æ¥éç¨‹ä¸­å‹•æ…‹åˆ‡æ›ã€‚

è—ç‰™ä½¿ç”¨ 6-byte ã€å”¯ä¸€çš„éœæ…‹åœ°å€åœ¨éˆè·¯å±¤è­˜åˆ¥è¨­å‚™ï¼Œä¸”è—ç‰™åœ°å€ä¸åŒ…å«ç§˜å¯†ä¿¡æ¯ï¼Œå¯é€šéè©¢å•éç¨‹ç²å–ã€‚åœ¨æ‡‰ç”¨å±¤ï¼Œè—ç‰™æä¾›äº†å¤šå€‹é…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚é«˜ç´šéŸ³é »åˆ†ç™¼ï¼ˆadvanced audio distribution / A2DPï¼‰é…ç½®æ–‡ä»¶ã€‚è—ç‰™æ§åˆ¶å™¨ç®¡ç†ç‰©ç†å±¤å’Œéˆè·¯å±¤ï¼Œè€Œè—ç‰™ä¸»æ©Ÿè² è²¬ä¸Šå±¤ã€‚ä¸»æ©Ÿå’Œæ§åˆ¶å™¨é€šéä¸»æ©Ÿæ§åˆ¶å™¨æ¥å£ï¼ˆHost Controller Interface / HCIï¼‰é€²è¡Œé€šä¿¡ï¼Œè©²å”è­°åŸºæ–¼å‘½ä»¤å’Œäº‹ä»¶ã€‚

![image](https://hackmd.io/_uploads/S1WveAx-0.png)

è—ç‰™æ¨™æº–åœ¨éˆè·¯å±¤åˆ¶å®šäº†å®‰å…¨æ©Ÿåˆ¶ï¼Œæ›¿ä¸Šå±¤æä¾› confidentialityã€ integrity å’Œ authenticityã€‚
- å®‰å…¨ç°¡æ˜“é…å°ï¼ˆSecure Simple Pairing / SSPï¼‰
    - é…å°å…è¨±è¨­å‚™å»ºç«‹ä¸€å€‹é•·æœŸ pairing keyï¼ˆPKï¼‰ã€‚
- æœƒè©±å»ºç«‹ä½¿é…å°çš„è¨­å‚™å¯ä»¥ä½¿ç”¨æ–°çš„æœƒè©±é‡‘é‘°ï¼ˆSession key / SKï¼‰å»ºç«‹å®‰å…¨æœƒè©±ã€‚
    - SK æ˜¯å¾ PK å’Œå¸¸æ•¸å’Œè®Šæ•¸è¡ç”Ÿå‡ºä¾†çš„ã€‚æ¨™æº–åŒ…æ‹¬å…©ç¨®å®‰å…¨æ¨¡å¼ï¼Œå½±éŸ¿é…å°å’Œæœƒè©±å»ºç«‹
        - LSC(legacy secure connection) ä½¿ç”¨å‚³çµ±å®‰å…¨æ©Ÿåˆ¶ä»¥é”åˆ°å‘å¾Œå…¼å®¹çš„ç›®çš„ï¼ˆä¾‹å¦‚ E0 å’Œ SAFER+ï¼‰
        - SC ä½¿ç”¨ç¬¦åˆ FIPS æ¨™æº–çš„æ©Ÿåˆ¶ï¼ˆä¾‹å¦‚ ECDHã€AES-CCM å’Œ HMACï¼‰ã€‚


## è—ç‰™çš„å‰å‘ä¿å¯†æ€§å’Œæœªä¾†ä¿å¯†æ€§ Forward and Future Secrecy
è—ç‰™æ¨™æº–æ²’æœ‰æ¶µè“‹ã€å®šç¾©å‰å‘å’Œæœªä¾†ä¿å¯†æ€§ã€‚æ–‡ç« ä¸­çš„ç ”ç©¶è€…åƒ…æ˜¯å¾æ¨™æº–ä¸­æª¢è¦–äº†é…å°å’Œæœƒè©±å»ºç«‹ï¼Œä¸¦å¾ä¸­æ¨å‡ºå®ƒå€‘çš„å‰å‘å’Œæœªä¾†ä¿å¯†æ€§ä¿è­‰ï¼š**æ¯å€‹å°è©±æœ‰ä¸åŒçš„ session keyã€‚ç ´è§£å…¶ä¸­ä¸€å€‹ session key ä¸¦ä¸æœƒæ”»æ“Šåˆ°ç”±å…¶ä»– session key æ‰€ä¿è­·çš„å°è©±å…§å®¹ã€‚** ä»¥ä¸‹æ˜¯æ›´å¤šé—œæ–¼ session key ç”¢ç”Ÿçš„èªªæ˜ã€‚

è—ç‰™æ‡‰è©²åœ¨æœƒè©±ä¹‹é–“æä¾›å‰å‘å’Œæœªä¾†ä¿å¯†æ€§ï¼Œç›´åˆ° ğ‘ƒğ¾ æˆ– ğ‘†ğ¾ å¯†é‘°è¡ç”Ÿå‡½æ•¸ï¼ˆkey derivation function / KDFï¼‰æœªå—åˆ°å¨è„…ç‚ºæ­¢ã€‚çŠ§ç‰²ç•¶å‰çš„ ğ‘†ğ¾ çš„æ”»æ“Šè€…ç„¡æ³•é‡å°éå»å’Œæœªä¾†çš„æœƒè©±ï¼Œå› ç‚ºæ¯å€‹æœƒè©±éƒ½ä½¿ç”¨å¾ ğ‘ƒğ¾ å’Œå¯è®Šé‡‘é‘°åˆ†åŒ–å™¨ (variable key diversifiers) æ‰€ç”¢ç”Ÿçš„fresh ğ‘†ğ¾ï¼Œå› æ­¤ï¼Œğ‘ƒğ¾ ä¿æŒç§˜å¯†ä¸¦ä¸” ğ‘†ğ¾ æ­£ç¢ºè¡ç”Ÿç›¸ç•¶é‡è¦ã€‚

ä»¥ä¸‹æ˜¯é—œæ–¼å‚³çµ±å°è©±(LSC)é‡‘é‘°å»ºç«‹çš„ä»‹ç´¹ã€‚å‡è¨­ Aliceï¼ˆ Centralï¼Œåœ°å€ç‚º $ğµğ´_ğ´$ï¼‰å’Œ Bobï¼ˆ Peripheralï¼Œåœ°å€ç‚º $ğµğ´_ğµ$ï¼‰å·²é…å°ä¸¦å…±äº«ğ‘ƒğ¾ã€‚å¦‚åœ–1 æ‰€ç¤ºï¼ŒLSCæœƒè©±å»ºç«‹å§‹æ–¼å…©å€‹æ¶ˆæ¯ï¼Œå…¶ä¸­ Alice å’Œ Bob è­˜åˆ¥è‡ªå·±ä¸¦å”å•† LSCã€‚ç„¶å¾Œï¼ŒAliceè¦æ±‚Bob é€šéç™¼é€æŒ‘æˆ° $ğ´ğ¶_ğ´$ ä¾†é©—è­‰ğ‘ƒğ¾ã€‚Bob å›å‚³ $ğ¶ğ‘…_ğµ$(å¾ ğ‘ƒğ¾ å’Œ $ğ´ğ¶_ğ´$ è¨ˆç®—å‡ºä¾†çš„ response)ã€‚

Alice æœƒæª¢æŸ¥ $ğ¶ğ‘…_ğµ$ æ˜¯å¦ç­‰æ–¼å¥¹æœ¬åœ°è¨ˆç®—çš„ responseã€‚æ¥è‘—ï¼ŒAliceç™¼é€ $ğ‘†ğ¸_ğ´$ï¼Œä¸€å€‹ä»‹æ–¼ 7~16 bytes çš„ ğ‘†ğ¾ ç†µæè­°(entropy proposal)ï¼ŒBobå¯ä»¥æ¥å—ï¼ˆå¦‚åœ–1æ‰€ç¤ºï¼‰æˆ–æå‡ºè¼ƒä½çš„å€¼ä¾› Alice æ¥å—ã€‚ä¸€æ—¦ ğ‘†ğ¾ ç†µå”å•†å®Œæˆï¼ŒAlice å‘ Bob ç™¼é€ $ğ‘†ğ·_ğ´$ï¼Œä¸€å€‹æœƒè©±é‡‘é‘°åˆ†åŒ–å™¨ï¼ŒBobç¢ºèªå¾Œã€‚æœ€å¾Œï¼Œè¨­å‚™ä½¿ç”¨ $ğ¾ğ·ğ¹_{ğ¿ğ‘†ğ¶}$ ä¸¦æ­é…å¯è®Šï¼ˆ$ğ´ğ¶_ğ´$ã€$ğ‘†ğ¸_ğ´$ã€$ğ‘†ğ·_ğ´$ï¼‰å’Œå›ºå®šè¼¸å…¥ï¼ˆğ‘ƒğ¾ã€$ğµğ´_ğµ$ï¼‰è¡ç”Ÿğ‘†ğ¾ã€‚

![æˆªåœ– 2024-04-19 ä¸­åˆ12.48.40](https://hackmd.io/_uploads/HJ3hPdJ-R.png =400x)

### session key ç”Ÿæˆå‡½æ•¸ä»‹ç´¹ $ğ¾ğ·ğ¹_{ğ¿ğ‘†ğ¶}$
$ğ¾ğ·ğ¹_{ğ¿ğ‘†ğ¶}$ æ˜¯åœ¨æ¨™æº–ä¸­æŒ‡å®šçš„LSCå¯†é‘°è¡ç”Ÿå‡½æ•¸ï¼Œå‡½æ•¸å…§å®¹å¦‚ä¸‹ï¼š

$ğ¾ğ·ğ¹_{ğ¿ğ‘†ğ¶} = 
\begin{cases}
ğ¶ğ‘‚ğ¹ =ğ‘’1(ğ‘ƒğ¾,ğ´ğ¶_ğ´,ğµğ´_ğµ)  .......(1a)\\
ğ¼ğ‘†ğ¾ = ğ‘’3(ğ‘ƒğ¾,ğ‘†ğ·_ğ´,ğ¶ğ‘‚ğ¹) .......(1b) \\
ğ‘†ğ¾=ğ‘’ğ‘ (ğ¼ğ‘†ğ¾,ğ‘†ğ¸_ğ´) ..............(1c) \\
\end{cases}$


- (1a)
    - è¨­å‚™å¾é…å°é‡‘é‘°ã€Aliceçš„èº«ä»½é©—è­‰æŒ‘æˆ°å’ŒBobçš„è—ç‰™åœ°å€è¨ˆç®—å‡ºä¸€å€‹åŠ å¯†åç§»æ•¸ï¼ˆğ¶ğ‘‚ğ¹ï¼‰ã€‚
    - è¨ˆç®—ä½¿ç”¨åŸºæ–¼SAFER+å€å¡ŠåŠ å¯†å™¨çš„ğ‘’1èº«ä»½é©—è­‰å‡½æ•¸ã€‚
- (1b)
    - é€šéæ–¹ç¨‹å¼1bè¨ˆç®—å‡ºä¸€å€‹ä¸­é–“æœƒè©±é‡‘é‘°ï¼ˆğ¼ğ‘†ğ¾ï¼‰ï¼Œä½¿ç”¨é…å°é‡‘é‘°ã€Aliceçš„æœƒè©±é‡‘é‘°åˆ†åŒ–å™¨å’ŒCOFã€‚
    - ä½¿ç”¨äº†ğ‘’3é‡‘é‘°ç”Ÿæˆå‡½æ•¸
- (1c)
    - ä½¿ç”¨ğ‘’ğ‘ å‡½æ•¸å°‡ğ¼ğ‘†ğ¾çš„ç†µæ¸›å°‘åˆ°$ğ‘†ğ¸_ğ´$ã€‚æ¸›å°‘å‡½æ•¸ä¾è³´æ–¼æœ‰é™çš„Galois field ä¸­çš„å¤šé …å¼ä¸Šçš„æ¨¡çµ„ç®—è¡“(modular arithmetic)ã€‚

## THREAT MODEL
### system model
æœ¬æ–‡ç« æ¢è¨çš„æ¨¡å‹è¨­å®šå¦‚ä¸‹ï¼š

æ­¤ç³»çµ±æ¨¡å‹è€ƒæ…®äº†ä¸€ç¨®æƒ…æ³ï¼Œå³ Alice å’Œ Bobï¼ˆå³å—å®³è€…ï¼‰å¸Œæœ›ä½¿ç”¨è—ç‰™é€²è¡Œå®‰å…¨é€šä¿¡ã€‚Alice å’Œ Bob ä»£è¡¨ä»»æ„è¨­å‚™ï¼ˆe.g. ç­†è¨˜æœ¬é›»è…¦ã€è€³æ©Ÿå’Œæ™ºèƒ½æ‰‹æ©Ÿï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ä»»ä½•è—ç‰™é…ç½®æ–‡ä»¶ï¼ˆe.g. éŸ³é »ã€å…æå’Œäº’è¯ç¶²æ©‹æ¥ï¼‰ã€‚

æˆ‘å€‘å‡è¨­å—å®³è€…å·²ç¶“ä½¿ç”¨ä»–å€‘æœ€å¼·çš„å®‰å…¨åŠŸèƒ½ï¼ˆä¾‹å¦‚SSPå’ŒSCï¼‰é€²è¡Œäº†é…å°ã€‚
å·²é…å°çš„å—å®³è€…ä½¿ç”¨è—ç‰™çš„æœƒè©±å»ºç«‹å»ºç«‹å®‰å…¨é€£æ¥ã€‚é™¤éå¦æœ‰èªªæ˜ï¼Œå¦å‰‡Alice æ˜¯ä¸­å¤®ï¼ˆç™¼èµ·è€…ï¼‰ï¼ŒBobæ˜¯å‘¨é‚Šï¼ˆæ‡‰ç­”è€…ï¼‰ã€‚å¦‚æœæ”»æ“Šè€…ç ´å£äº†ç•¶å‰çš„ğ‘†ğ¾ï¼Œå¥¹æ‡‰è©²ç„¡æ³•ç ´å£éå»å’Œæœªä¾†çš„æœƒè©±ï¼ˆå³ç ´å£å‰å‘å’Œæœªä¾†æœƒè©±çš„ä¿å¯†æ€§ï¼‰ï¼Œå› ç‚ºæ¯å€‹æœƒè©±éƒ½ä½¿ç”¨ä¸€å€‹æ–°çš„ï¼ˆå³ä¸åŒçš„ï¼‰ğ‘†ğ¾ã€‚

### Attacker Model
æœ¬æ–‡ä»¥ Charlie ä½œç‚ºæ”»æ“Šæ¨¡å‹ï¼Œä¸€å€‹åœ¨è—ç‰™ç¯„åœå…§èˆ‡å—å®³è€…æ¥è¿‘çš„æ”»æ“Šè€…ã€‚

æ”»æ“Šè€…å¯ä»¥æ•ç²è—ç‰™å°åŒ…ï¼Œå…¶ä¸­åŒ…æ‹¬æ˜æ–‡(plaintext)ï¼ˆe.g. èº«ä»½é©—è­‰æŒ‘æˆ°ã€key diversifiers å’Œ negotiated entropy valuesï¼‰å’Œå¯†æ–‡(ciphertext)ï¼ˆä¾‹å¦‚åŠ å¯†çš„éŸ³é »ã€æ–‡ä»¶æˆ–ç¶²è·¯æµé‡/internet trafficï¼‰ã€‚Charlie çŸ¥é“å—å®³è€…çš„è—ç‰™åœ°å€ï¼Œå¯ä»¥è—‰æ­¤è£½ä½œï¼ˆç¬¦åˆæ¨™æº–çš„ï¼‰è—ç‰™å°åŒ…ï¼Œä¸¦å”å•†ä»»æ„åŠŸèƒ½ã€‚

Charlie ä¸èƒ½ç ´å£ ğ‘ƒğ¾ï¼Œå› æ­¤ç„¡æ³•åœ¨å—å®³è€…é€²è¡Œé…å°æ™‚è§€å¯Ÿå®ƒå€‘ï¼›ä¸èƒ½è§¸ç™¼æ–°çš„é…å°äº‹ä»¶ï¼›ä¸èƒ½ç¯¡æ”¹å—å®³è€…çš„è¨­å‚™ï¼ŒåŒ…æ‹¬å®ƒå€‘çš„ç¡¬ä»¶å’Œè»Ÿä»¶å…ƒä»¶ã€‚æ”»æ“Šè€…åƒ…å¯å°‡ ğ‘†ğ¾ çš„ç†µé™ç´šç‚ºå—å®³è€…æ”¯æŒçš„æœ€ä½å€¼ï¼ˆä¾‹å¦‚æœªä¿®è£œKNOBæ”»æ“Šçš„è¨­å‚™æˆ–7å­—ç¯€ï¼‰ï¼Œä¸¦å° ğ‘†ğ¾é€²è¡Œæš´åŠ›ç ´è§£ã€‚

Charlieå¸Œæœ›ç ´å£Aliceå’ŒBobæœƒè©±çš„å‰å‘å’Œæœªä¾†ä¿å¯†æ€§ã€‚ä¾‹å¦‚ï¼Œå¥¹æƒ³è¦å†’å……Aliceå°Bobï¼ŒBobå°Aliceï¼Œæˆ–åœ¨æœƒè©±ä¹‹é–“é€²è¡Œä¸­é–“äººæ”»æ“Šï¼Œä»¥è§£å¯†éå»çš„æ¶ˆæ¯ï¼ˆå³ç ´å£å‰å‘ä¿å¯†æ€§ï¼‰ä¸¦è§£å¯†æˆ–æ³¨å…¥æœªä¾†çš„æ¶ˆæ¯ï¼ˆå³ç ´å£æœªä¾†ä¿å¯†æ€§ï¼‰ã€‚é€™äº›ç›®æ¨™æ˜¯æ–°çš„ï¼Œå› ç‚ºç¾æœ‰æŠ€è¡“å‡è¨­æ”»æ“Šè€…æœƒé‡å°ç•¶å‰æœƒè©±ã€‚

æ­¤å¤–ï¼Œæ”»æ“Šè€…å¸Œæœ›åˆ©ç”¨ä»»ä½•è—ç‰™è¨­å‚™ä¾†å®Œæˆæ­¤æ”»æ“Šï¼Œç„¡è«–è©²è¨­å‚™è—ç‰™åŠŸèƒ½å¦‚ä½•ï¼ˆä¾‹å¦‚èŠ¯ç‰‡ã€ç‰ˆæœ¬ã€è»Ÿä»¶å †æ£§ã€å®‰å…¨æ¨¡å¼å’Œæ”¯æŒçš„é…ç½®æ–‡ä»¶ï¼‰ã€‚

### notation
ä»¥ä¸‹æ˜¯æœ¬æ–‡ç¸®å¯«èªªæ˜
- ğµğ´ï¼šè—ç‰™åœ°å€
- ğ´ğ¶ï¼šèº«ä»½é©—è­‰æŒ‘æˆ°(æ¨™æº–ä¸­çš„AU_RAND)
- ğ¶ğ‘…ï¼šæŒ‘æˆ°-éŸ¿æ‡‰ï¼ˆæ¨™æº–ä¸­çš„SRESï¼‰
- ğ‘†ğ¾ï¼šæœƒè©±é‡‘é‘°ï¼ˆæ¨™æº–ä¸­çš„Kcâ€™ï¼‰
- ğ‘ƒğ¾ï¼šé…å°é‡‘é‘°ï¼ˆæ¨™æº–ä¸­çš„LKï¼‰
- ğ‘†ğ¸ï¼šæœƒè©±é‡‘é‘°ç†µæè­°
- ğ‘†ğ·ï¼šæœƒè©±é‡‘é‘°åˆ†åŒ–å™¨ï¼ˆæ¨™æº–ä¸­çš„EN_RANDï¼‰
- ğ¾ğ·ğ¹ï¼šå¯†é‘°è¡ç”Ÿå‡½æ•¸
- A, Bï¼šAliceã€Bobï¼ˆå—å®³è€…ï¼‰
- Cï¼šCharlieï¼ˆæ”»æ“Šè€…ï¼‰

# BLUFFS æ”»æ“Š
## æ”»æ“Šèªªæ˜
### ç­–ç•¥
BLUFFSæ”»æ“Šåˆ©ç”¨äº†ä¸€ç¨®æ–°çš„æ”»æ“Šç­–ç•¥ï¼Œä½¿Charlieå¯ä»¥è·¨æœƒè©±é‡è¤‡ä½¿ç”¨ä¸€å€‹å¼±æœƒè©±é‡‘é‘°($ğ‘†ğ¾_ğ¶$)ä¾†æ¬ºé¨™æˆ–ä¸­é–“äºº(MitM)ä»»æ„å—å®³è€…ï¼ˆe.g. LSCã€SC ä¸­å¤®å’Œå‘¨é‚Šè¨­å‚™ï¼‰ã€‚

åœ–äºŒæè¿°ç ”ç©¶è€…å½é€ æ”»æ“Šè¨­ç½®ä¸­çš„ä¸€ç¨®ç­–ç•¥ã€‚Charlieä½¿ç”¨Aliceçš„è—ç‰™åœ°å€ï¼ˆ$ğµğ´_ğ´$ï¼‰å‘Bobè¡¨ç¤ºï¼Œè©²åœ°å€æ˜¯é€šéè—ç‰™æŸ¥è©¢ç¨‹åºç­‰æ–¹å¼å»åŒ¿åæ”»æ“Šç²å–ã€‚å¥¹å”å•† LSC æ¨¡å¼ï¼ˆLSCï¼‰ï¼Œç„¡è«–Bobæ˜¯å¦æ”¯æŒLSCæˆ–SCï¼Œæœ€çµ‚éƒ½æœƒå¼·åˆ¶é€²è¡ŒLSCæœƒè©±å»ºç«‹ï¼ˆå’Œé‡‘é‘°è¡ç”Ÿï¼‰ã€‚

å¦‚æœCharlieæ˜¯ä¸€å€‹å‘¨é‚Šè¨­å‚™ï¼Œå¥¹æœƒåˆ‡æ›åˆ°ä¸­å¤®è§’è‰²ä¾†å¼•å°æœƒè©±å»ºç«‹ï¼ŒåŒ…æ‹¬ğ‘†ğ¾è¡ç”Ÿã€‚å› æ­¤ï¼ŒCharlieå¯ä»¥å°‡Bobä½œç‚ºä¸­å¤®ï¼ˆç™¼èµ·è€…ï¼‰æˆ–å‘¨é‚Šï¼ˆæ‡‰ç­”è€…ï¼‰ä¾†æ”»æ“Šã€‚Charlieé€šéç™¼é€ä¸€å€‹å›ºå®šçš„èº«ä»½é©—è­‰æŒ‘æˆ°($ğ´ğ¶_ğ¶$)ï¼Œå¿½ç•¥Bobçš„response($ğ¶ğ‘…_ğ¶$)ï¼Œä¸¦æå‡ºæœ€ä½çš„æœƒè©±é‡‘é‘°ç†µå€¼($ğ‘†ğ¸_ğ¶$)ä¾†é‡æ–°å»ºç«‹ä¸€å€‹å¼±é‡‘é‘°ï¼Œæœ€å¾Œæå‡ºä¸€å€‹æ†å®šçš„æœƒè©±é‡‘é‘°åˆ†åŒ–å™¨$ğ‘†ğ·_ğ¶$ã€‚


æœ€çµ‚ï¼ŒBobé€šéä½¿ç”¨$ğ¾ğ·ğ¹_{ğ¿ğ‘†ğ¶}$èˆ‡æ†å®šè¼¸å…¥(ğ‘ƒğ¾ï¼Œ$ğµğ´_ğµ$ï¼Œ$ğ´ğ¶_ğ¶$ï¼Œ$ğ‘†ğ¸_ğ¶$å’Œ$ğ‘†ğ·_ğ¶$)é‡æ–°æ¨å°$ğ‘†ğ¾_ğ¶$ã€‚ä¾‹å¦‚ï¼ŒCharlieå¯ä»¥å°‡$ğ´ğ¶_ğ¶$å’Œ$ğ‘†ğ·_ğ¶$è¨­ç½®ç‚ºé›¶ï¼Œå°‡$ğ‘†ğ¸_ğ¶$è¨­ç½®ç‚ºä¸€ï¼ˆ$ğ‘†ğ¾_ğ¶$å…·æœ‰ 1 byte çš„ entropyï¼‰ã€‚


![æˆªåœ– 2024-04-19 ä¸‹åˆ1.55.00](https://hackmd.io/_uploads/Sy2rPFkb0.png)

### å…­ç¨®æ”»æ“Š
ç ”ç©¶è€…å¥—ç”¨å…ˆå‰æåŠçš„æ”»æ“Šç­–ç•¥å»è¨­è¨ˆäº†å…­ç¨®æ”»æ“Šï¼Œæ¶µè“‹äº†æ‰€æœ‰åœ¨æœƒè©±ä¹‹é–“é€²è¡Œå½è£å’Œä¸­é–“äººæ”»æ“Šçš„çµ„åˆï¼ˆå³é‡å°SCå’ŒLSCä¸­å¤®å’Œå‘¨é‚Šè¨­å‚™ï¼‰ã€‚å¦‚ä¸‹åˆ—èˆ‰æ‰€ç¤ºï¼Œæ”»æ“Šè€…å¯ä»¥æ¬ºé¨™ä¸€å€‹LSCä¸­å¤®æˆ–å‘¨é‚Šè¨­å‚™å°ä¸€å€‹LSCæˆ–SCå—å®³è€…é€²è¡Œå½è£ï¼ˆå³A1ã€A2ï¼‰ï¼Œå†’å……ä¸€å€‹SCä¸­å¤®æˆ–å‘¨é‚Šè¨­å‚™å°ä¸€å€‹LSCæˆ–SCå—å®³è€…é€²è¡Œå½è£ï¼ˆå³A4ã€A5ï¼‰ï¼Œæˆ–å°ä¸€å€‹å—å®³è€…æ”¯æŒLSCæˆ–å…©å€‹å—å®³è€…æ”¯æŒSCçš„æœƒè©±é€²è¡Œä¸­é–“äººæ”»æ“Šï¼ˆå³A3ã€A6ï¼‰ã€‚

- A1: å½è£ä¸€å€‹LSCä¸­å¤®è¨­å‚™å°ä¸€å€‹å‘¨é‚Šè¨­å‚™å—å®³è€…é€²è¡Œæ”»æ“Š
- A2: å½è£ä¸€å€‹LSCå‘¨é‚Šè¨­å‚™å°ä¸€å€‹ä¸­å¤®è¨­å‚™å—å®³è€…é€²è¡Œæ”»æ“Š
- A3: åœ¨ä¸€å€‹å—å®³è€…æ”¯æŒLSCçš„æœƒè©±ä¸­é€²è¡Œä¸­é–“äººæ”»æ“Š
- A4: å½è£ä¸€å€‹SCä¸­å¤®è¨­å‚™å°ä¸€å€‹å‘¨é‚Šè¨­å‚™å—å®³è€…é€²è¡Œæ”»æ“Š
- A5: å½è£ä¸€å€‹SCå‘¨é‚Šè¨­å‚™å°ä¸€å€‹ä¸­å¤®è¨­å‚™å—å®³è€…é€²è¡Œæ”»æ“Š
- A6: åœ¨å…©å€‹å—å®³è€…æ”¯æŒSCçš„æœƒè©±ä¸­é€²è¡Œä¸­é–“äººæ”»æ“Š

BLUFFSæ”»æ“Šåœ¨ä¸çŠ§ç‰²å—å®³è€…å…ˆå‰çš„ ğ‘†ğ¾ (å®‰å…¨æ€§è¼ƒå¼·)çš„æƒ…æ³ä¸‹ç ´å£äº†è—ç‰™çš„æœƒè©±å‰å‘å’Œæœªä¾†çš„ä¿å¯†æ€§ã€‚

å¦‚æœCharlieç ´å£äº†$ğ‘†ğ¾_ğ¶$ï¼Œæˆ‘å€‘èªç‚ºå‰å‘/æœªä¾†ä¿å¯†æ€§è¢«ç ´å£ã€‚å¦‚åœ–3ä¸­çš„æ™‚é–“è»¸æ‰€ç¤ºï¼Œæ”»æ“Šè€…åœ¨æ™‚é–“ ğ‘¡1 ç™¼å‹•äº†ä¸€æ¬¡ä¸­é–“äººæ”»æ“Šä¾†å¼·åˆ¶ä½¿ç”¨$ğ‘†ğ¾_ğ¶$ï¼ˆA3æˆ–A6ï¼‰ï¼Œæ•ç²äº†ç•¶å‰å’Œéš¨å¾Œæœƒè©±çš„ trafficï¼Œä¸¦é–‹å§‹å°$ğ‘†ğ¾_ğ¶$ é€²è¡Œæš´åŠ›ç ´è§£ã€‚åœ¨ ğ‘¡2 > ğ‘¡1 æ™‚ï¼ŒCharlie å° $ğ‘†ğ¾_ğ¶$ é€²è¡Œäº†æš´åŠ›ç ´è§£ï¼Œä¸¦è§£å¯†äº†è‡ª ğ‘¡1 ä»¥ä¾†äº¤æ›çš„æ‰€æœ‰éå»æ¶ˆæ¯ï¼Œå¾è€Œé•åäº†å‰å‘ä¿å¯†æ€§ã€‚åœ¨ ğ‘¡3 > ğ‘¡2æ™‚ï¼Œå¥¹é‡è¤‡ä½¿ç”¨ $ğ‘†ğ¾_ğ¶$ä¾†å†’å……æˆ–ä¸­é–“äººæ”»æ“ŠAliceå’ŒBobåœ¨æ¥ä¸‹ä¾†çš„æœƒè©±ä¸­ï¼ˆA1ã€A2ã€A3ã€A4ã€A5å’ŒA6ï¼‰ã€‚å› æ­¤ï¼Œå¥¹é€šéå¾ ğ‘¡2 é–‹å§‹é•åæœƒè©±çš„ä¿å¯†æ€§ã€å®Œæ•´æ€§å’ŒçœŸå¯¦æ€§ï¼Œç ´å£äº†æœªä¾†çš„ä¿å¯†æ€§ã€‚

![æˆªåœ– 2024-04-19 ä¸‹åˆ2.09.32](https://hackmd.io/_uploads/BJTj9tybA.png)


### æš´åŠ›ç ´è§£çš„è¨­ç½®
Charlieä½¿ç”¨ä¸€ç¨®é›¢ç·šä¸”å¯ä¸¦è¡ŒåŒ–(parallelizabl)çš„è¨­ç½®ä¾†å°$ğ‘†ğ¾_ğ¶$é€²è¡Œæš´åŠ›ç ´è§£ã€‚ä»–ä½¿ç”¨å·²çŸ¥çš„è—ç‰™å°åŒ…å­—æ®µä½œç‚º oraclesï¼ˆä¾‹å¦‚ï¼Œè§£å¯†ç‚ºå·²çŸ¥å¸¸é‡çš„L2CAPå’ŒRFCOMMæ¨™é ­ï¼‰å°å¤šå€‹æœƒè©±å¯†é‘°é€²è¡Œé›¢ç·šæ¸¬è©¦ï¼Œèˆ‡ä¸€å€‹æˆ–å¤šå€‹è¢«ç™¼ç¾çš„å¯†æ–‡é€²è¡Œæ¯”å°ã€‚

$ğ‘†ğ¸_ğ¶$ï¼ˆå³ğ‘†ğ¾çš„ç†µï¼‰è¶Šé•·ï¼Œæ”»æ“Šè€…ç ´è§£å°±è¶Šä¸å®¹æ˜“ã€‚ç„¶è€Œï¼Œå®ƒä¸ä¾è³´æ–¼æ‰€é‡å°çš„æœƒè©±æ•¸é‡ï¼Œé€™åœ¨å…·æœ‰é©ç•¶çš„å‰å‘å’Œæœªä¾†ä¿å¯†æ€§æ©Ÿåˆ¶çš„æƒ…æ³ä¸‹æ‡‰è©²æ˜¯æœ‰çš„ã€‚

å¦‚æœ $ğ‘†ğ¸_ğ¶=1$ï¼Œæš´åŠ›ç ´è§£çš„åŠªåŠ›æ˜¯å¯ä»¥å¿½ç•¥çš„ï¼Œå› ç‚ºåœ¨256 (=$2^{8}$)å€‹å…ƒç´ çš„å¯†é‘°ç©ºé–“ä¸­ï¼Œå¹³å‡åªéœ€è¦é€²è¡Œ 128 (=$2^{7}$) æ¬¡å˜—è©¦ï¼›å¦‚æœæ˜¯ $ğ‘†ğ¸_ğ¶=7$ï¼Œæ”»æ“Šè€…åœ¨ $2^{56}$ å€‹å…ƒç´ çš„å¯†é‘°ç©ºé–“ä¸­å¹³å‡éœ€è¦$2^{55}$æ¬¡å˜—è©¦ã€‚åŸºæ–¼æ•¸æ“šåŠ å¯†æ¨™æº–ï¼ˆ data encryption standard / DESï¼‰ç­‰å·¥å…·ï¼Œç ”ç©¶è€…ä¼°è¨ˆå°æ–¼ä½¿ç”¨å•†æ¥­è¨­å‚™çš„ä½æˆæœ¬æ”»æ“Šè€…ä¾†èªªï¼Œç ´è§£ $ğ‘†ğ¸_ğ¶=7$ éœ€è¦ä¸€å…©å€‹æ˜ŸæœŸçš„ä¸­ç­‰åŠªåŠ›ï¼Œè€Œå°æ–¼ä½¿ç”¨åˆ†ä½ˆå¼è¨ˆç®—æˆ–å„ªåŒ–ç¡¬ä»¶çš„è³‡é‡‘å……è£•çš„æ”»æ“Šè€…ä¾†èªªï¼Œé€™åƒ…éœ€è¦ä¸€åˆ°å¹¾å¤©çš„æ™‚é–“å°±å¯ä»¥å®Œæˆç ´è§£ã€‚

### å½±éŸ¿
BLUFFSæ”»æ“Šå°å…è¨±é‡è¤‡ä½¿ç”¨å–®å€‹æœƒè©±å¯†é‘°ä¾†è§£å¯†æµé‡ä¸¦åœ¨æœƒè©±ä¹‹é–“æ³¨å…¥æˆæ¬Šæ¶ˆæ¯ã€‚ä»¥å‰çš„æ”»æ“Šéœ€è¦æ´©æ¼ğ‘ƒğ¾æˆ–å°æ¯å€‹ç›®æ¨™æœƒè©±é€²è¡Œä¸€æ¬¡ğ‘†ğ¾çš„æš´åŠ›ç ´è§£æ‰èƒ½é”åˆ°é¡ä¼¼çš„å½±éŸ¿ã€‚

å› ç‚ºBLUFFSæ”»æ“Šä¾è³´æ¨™æº–ä¸­çš„ç¼ºé™·ï¼Œæ‰€ä»¥æ­¤æ”»æ“Šå¯ä»¥é‡å°ä»»ä½•è—ç‰™è¨­å‚™ï¼Œç„¡è«–å…¶è§’è‰²ã€å®‰å…¨æ¨¡å¼å’Œæ”¯æŒçš„è—ç‰™é…ç½®æ–‡ä»¶å¦‚ä½•ã€‚æ­¤å¤–ï¼Œç”±æ–¼æ”»æ“Šåˆ©ç”¨äº†è—ç‰™å›ºä»¶ï¼ˆæ§åˆ¶å™¨ï¼‰ï¼Œè€Œç„¡éœ€ç”¨æˆ¶äº¤äº’å’Œè§¸ç™¼ç”¨æˆ¶é€šçŸ¥ï¼Œå› æ­¤æ”»æ“Šæ˜¯éš±è”½çš„ã€‚

æœ€å¾Œï¼Œæ”»æ“Šä¸éœ€è¦å°ˆé–€çš„æ˜‚è²´è¨­å‚™ï¼Œä¸¦ä¸”å…·æœ‰å»£æ³›çš„å½±éŸ¿ã€‚

## æ”»æ“Šçš„æ ¹æœ¬åŸå› 
BLUFFSæ”»æ“Šçš„æ ¹æœ¬åŸå› åœ¨æ–¼è—ç‰™æœƒè©±å»ºç«‹è¦ç¯„ä¸­å­˜åœ¨çš„å››å€‹æ¶æ§‹æ€§æ¼æ´ï¼ˆå³RC1ã€RC2ã€RC3å’ŒRC4ï¼‰ã€‚å…¶ä¸­RC1å’ŒRC2æ˜¯æ–°ç©çš„ï¼Œå› ç‚ºå®ƒå€‘æ˜¯é¦–æ¬¡é‡å°ğ‘†ğ¾è¡ç”Ÿä¸¦å…è¨±åœ¨æœƒè©±ä¹‹é–“è¡ç”Ÿç›¸åŒçš„ğ‘†ğ¾ï¼ˆç ´å£å…¶å‰å‘å’Œæœªä¾†ä¿å¯†æ€§ï¼‰ã€‚è€ŒRC3å’ŒRC4åœ¨éå»éƒ½æœ‰è¢«ä½¿ç”¨çš„ä¾‹å­ï¼Œç”¨ä¾†æ”»æ“Šå…¶ä»–æœƒè©±å»ºç«‹éšæ®µï¼Œä¾‹å¦‚BIASæ”»æ“Šåˆ©ç”¨RC3å’ŒRC4ä¾†ç¹éğ‘ƒğ¾é©—è­‰ï¼Œè€ŒKNOBæ”»æ“Šå‰‡åˆ©ç”¨å®ƒå€‘ä¾†é™ä½ğ‘†ğ¾çš„ç†µã€‚



#### RC1
- LSC ğ‘†ğ¾å¤šæ¨£åŒ–æ˜¯å–®å‘çš„ï¼ˆæ–°ï¼‰ã€‚
- é€é LSC SKDFä½¿ç”¨éœæ…‹è¼¸å…¥ï¼ˆå³ğ‘ƒğ¾ï¼Œğµğ´ï¼‰å’Œè®Šæ•¸è¼¸å…¥ï¼ˆå³ğ´ğ¶ï¼Œğ‘†ğ¸ï¼Œğ‘†ğ·ï¼‰ç”¢ç”Ÿğ‘†ğ¾ã€‚å› ç‚ºè®Šæ•¸è¼¸å…¥ä½¿ğ‘†ğ¾åœ¨æœƒè©±ä¹‹é–“å¤šæ¨£åŒ–ã€‚
- äººå€‘å¯èƒ½æœƒæœŸæœ›ä¸­å¿ƒå’Œå‘¨é‚Šè¨­å‚™éƒ½èƒ½å°ğ‘†ğ¾é€²è¡Œå¤šæ¨£åŒ–è²¢ç»ã€‚ç„¶è€Œï¼Œ**æ¨™æº–åªå…è¨±ä¸­å¿ƒè¨­å®šæ‰€æœ‰çš„ğ‘†ğ¾å¤šæ¨£åŒ–å€¼**ã€‚å› æ­¤ï¼Œå†’å……ä¸­å¿ƒçš„æ”»æ“Šè€…ï¼ˆæˆ–åœ¨å†’å……å‘¨é‚Šè¨­å‚™æ™‚åˆ‡æ›åˆ°ä¸­å¿ƒï¼‰å¯ä»¥å–®æ–¹é¢é©…å‹•ğ‘†ğ¾å¤šæ¨£åŒ–ï¼ˆè·¨æœƒè©±ï¼‰ã€‚

#### RC2
- LSC ğ‘†ğ¾ å¤šæ¨£åŒ–ä¸ä½¿ç”¨nonceï¼ˆæ–°ï¼‰ã€‚
- ğ‘†ğ¾æ˜¯ä½¿ç”¨éš¨æ©Ÿæ•¸(diversification)ï¼ˆğ´ğ¶å’Œğ‘†ğ·ï¼‰å’Œæ­£æ•´æ•¸ï¼ˆğ‘†ğ¸ï¼‰é€²è¡Œå¤šæ¨£åŒ–ã€‚ç”±æ–¼é€™äº›å€¼éƒ½ä¸æ˜¯nonceï¼Œå®ƒå€‘å¯ä»¥åœ¨ä¸é•åæ¨™æº–çš„æƒ…æ³ä¸‹åœ¨éå»ã€ç¾åœ¨å’Œæœªä¾†çš„æœƒè©±ä¸­é‡è¤‡ä½¿ç”¨ã€‚å› æ­¤ï¼Œå¦‚æœæ”»æ“Šè€…çŸ¥é“ä¸€çµ„ä¸‰å…ƒçµ„ï¼ˆ$ğ´ğ¶_ğ¶$ï¼Œ$ğ‘†ğ¸_ğ¶$ï¼Œ$ğ‘†ğ·_ğ¶$ï¼‰å’Œç›¸æ‡‰çš„$ğ‘†ğ¾_ğ¶$ï¼Œå¥¹å¯ä»¥å¼·åˆ¶å—å®³è€…åœ¨æœƒè©±ä¹‹é–“è¡ç”Ÿå‡ºç›¸åŒçš„ç”±æ”»æ“Šè€…æ§åˆ¶çš„æœƒè©±å¯†é‘°ã€‚

#### RC3
- LSC ğ‘†ğ¾å¤šæ¨£åŒ–å› å­(diversifiers)æ²’æœ‰å®Œæ•´æ€§ä¿è­·ã€‚
- åœ¨ğ‘†ğ¾è¡ç”Ÿéç¨‹ä¸­äº¤æ›çš„è®Šæ•¸è¼¸å…¥æ˜¯æ²’æœ‰å®Œæ•´æ€§ä¿è­·çš„ã€‚å› æ­¤ï¼Œåœ¨å½è£è¨­å‚™æˆ–å°æœƒè©±åŸ·è¡ŒMitMçš„æ”»æ“Šè€…å¯ä»¥æ“ç¸±ğ´ğ¶ï¼Œğ‘†ğ¸å’Œğ‘†ğ·ï¼Œè€Œä¸æœƒè¢«æª¢æ¸¬åˆ°ã€‚

#### RC4
- å°‡SCé™ç´šç‚ºLSCä¸éœ€è¦é©—è­‰ã€‚
- SCæˆ–LSCçš„å”å•†æ²’æœ‰å®Œæ•´æ€§ä¿è­·ã€‚å› æ­¤ï¼Œç„¡è«–å—å®³è€…æ˜¯å¦æ”¯æŒSCï¼Œæ”»æ“Šè€…å§‹çµ‚å¯ä»¥å°‡æœƒè©±é™ç´šç‚ºLSCï¼Œä¸¦è§¸ç™¼LSCå¯†é‘°å”å•†å’Œ$ğ¾ğ·ğ¹_{ğ¿ğ‘†ğ¶}$ã€‚

### åœ–è¡¨èªªæ˜
è¡¨1é¡¯ç¤ºå…­ç¨®BLUFFSæ”»æ“Šå¦‚ä½•æ˜ å°„åˆ°RC1ã€RC2ã€RC3å’ŒRC4ã€‚æ‰€æœ‰æ”»æ“Šéƒ½åˆ©ç”¨äº†RC1ã€RC2å’ŒRC3ï¼Œå› ç‚ºå®ƒå€‘åœ¨æ²’æœ‰ä½¿ç”¨nonceçš„æƒ…æ³ä¸‹å–®æ–¹é¢è¡ç”Ÿå‡ºä¸€å€‹å¸¸é‡æœƒè©±å¯†é‘°ï¼Œä¸¦æ“ç¸±æœƒè©±å¯†é‘°å¤šæ¨£åŒ–å› å­çš„å®Œæ•´æ€§ã€‚RC4è¢«ä¸‰ç¨®é‡å°SCçš„BLUFFSæ”»æ“Šæ‰€åˆ©ç”¨ï¼Œå°‡ä¸€å€‹æœƒè©±é™ç´šç‚ºLSCã€‚

![æˆªåœ– 2024-04-19 ä¸‹åˆ3.04.23](https://hackmd.io/_uploads/ByPtPqk-A.png)

## BLUFFS å’Œ BIAS èˆ‡ KNOB çš„å·®ç•°
KNOB+BIASæ”»æ“Šéˆè¢«èªç‚ºæ˜¯åœ¨æœƒè©±å»ºç«‹æœŸé–“å†’å……è—ç‰™è¨­å‚™çš„æœ€æœ‰æ•ˆæ–¹æ³•ã€‚æ”»æ“Šè€…åˆ©ç”¨BIASä¾†ç¹éğ‘ƒğ¾çš„é©—è­‰ï¼Œç„¶å¾Œåˆ©ç”¨KNOBä¾†é™ä½ğ‘†ğ¾çš„ç†µã€‚BLUFFSæ”»æ“Šå…·æœ‰ç›¸åŒçš„ç›®æ¨™ï¼Œä½†æ¡ç”¨ä¸åŒçš„æ­¥é©Ÿï¼ˆä¾‹å¦‚ï¼Œæ”»æ“Šğ‘†ğ¾æ¨å°ï¼‰ï¼Œé€™äº›æ­¥é©Ÿå¯ä»¥èˆ‡BIASå’ŒKNOBæ”»æ“Šé€£é–ä½¿ç”¨ã€‚

ç„¶è€Œï¼Œèˆ‡BLUFFSæ”»æ“Šä¸åŒï¼ŒKNOB+BIASéˆä¸æœƒå±åŠå‰å‘å’Œæœªä¾†çš„ä¿å¯†æ€§ï¼Œå› ç‚ºå®ƒåƒ…åœ¨ç•¶å‰æœƒè©±ä¸­æœ‰æ•ˆã€‚

>ä»¥å‰çš„ç ”ç©¶æ²’æœ‰èª¿æŸ¥æŒçºŒè·¨æœƒè©±å­˜åœ¨çš„æœƒè©±å»ºç«‹æ¼æ´å’Œæ”»æ“Šçš„å­˜åœ¨ï¼ˆå³æ²’æœ‰é—œæ–¼è—ç‰™æœƒè©±çš„å‰å‘å’Œæœªä¾†ä¿å¯†æ€§çš„ç ”ç©¶ï¼‰ã€‚

å³ä½¿ä¿®å¾©äº†BIASè«–æ–‡ä¸­è¨è«–çš„è§’è‰²åˆ‡æ›å’ŒSCæœƒè©±é™ç´šæ¼æ´ï¼ŒBLUFFSæ”»æ“Šä»ç„¶æˆåŠŸã€‚æ”»æ“Šè€…å¯ä»¥å°ä»»ä½•LSCè¨­å‚™é‡è¤‡ä½¿ç”¨$ğ‘†ğ¾_ğ¶$ï¼ŒåŒæ™‚å†’å……LSCä¸­å¤®ï¼ˆA1ï¼‰ã€‚ç‰¹åˆ¥æ˜¯ï¼Œæ”»æ“Šè€…å¯ä»¥åˆæ³•åœ°å”å•†LSCï¼Œ$ğ´ğ¶_ğ¶$ï¼Œ$ğ‘†ğ¸_ğ¶$ï¼Œ$ğ‘†ğ·_ğ¶$ï¼Œä¸¦ä¸”ä¸éœ€è¦é©—è­‰ğ‘ƒğ¾ã€‚æ­¤å¤–ï¼Œå·²ä¿®è£œå°æŠ—KNOBæ”»æ“Šçš„è¨­å‚™ä»ç„¶å®¹æ˜“å—åˆ°BLUFFSæ”»æ“Šçš„å½±éŸ¿ï¼Œå› ç‚ºå®ƒå€‘æ¥å—$ğ‘†ğ¸_ğ¶$ç­‰æ–¼ä¸ƒã€‚

æˆ‘å€‘å•Ÿç”¨äº†æ”»æ“Šå ´æ™¯ï¼Œé€™å°KNOB+BIASä¾†èªªæˆæœ¬å¤ªé«˜ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘å€‘é‡å°$ğ‘_ğ‘ $å€‹æœƒè©±ï¼Œæˆ‘å€‘æ”»æ“Šçš„æˆæœ¬ä¸æœƒéš¨è‘—$ğ‘_ğ‘ $å¢åŠ ï¼Œå› ç‚ºæˆ‘å€‘æš´åŠ›ç ´è§£ä¸€å€‹æœƒè©±é‡‘é‘°ã€‚è€ŒKNOB+BIASçš„æˆæœ¬é¡¯è‘—æ›´é«˜ï¼Œå› ç‚ºå®ƒéš¨$ğ‘_ğ‘ $ç·šæ€§å¢åŠ ã€‚å¦‚æœå—å®³è€…æ”¯æŒé«˜æ–¼ä¸ƒå€‹å­—ç¯€çš„ç†µå€¼ï¼ˆğ‘†ğ¸ï¼‰ï¼Œå‰‡æˆæœ¬å·®ç•°æ›´å…·èªªæœåŠ›ã€‚

>å‡è¨­æš´åŠ›ç ´è§£å…·æœ‰ä¸ƒå€‹å­—ç¯€ç†µçš„ğ‘†ğ¾éœ€è¦ä¸€å‘¨ï¼ˆå¯†é‘°ç©ºé–“ç‚º$2^{56}$ï¼‰ï¼Œè€Œå…·æœ‰åå…­å€‹å­—ç¯€ç†µçš„ğ‘†ğ¾éœ€è¦ä¸€åƒå¹´ï¼ˆå¯†é‘°ç©ºé–“ç‚º$2^{128}$ï¼‰ï¼›é‚£éº¼æˆ‘å€‘çš„æ”»æ“Šå°ä¸ƒå€‹å­—ç¯€ç†µçš„æˆæœ¬ç‚ºä¸€å‘¨ï¼Œå°åå…­å€‹å­—ç¯€ç†µçš„æˆæœ¬ç‚ºä¸€åƒå¹´ï¼Œè€ŒKNOB+BIASçš„æˆæœ¬å‰‡ç‚º$ğ‘_ğ‘ $å‘¨å’Œ$ğ‘_ğ‘ $åƒå¹´ã€‚


# BLUFFS å·¥å…·åŒ…
## Attack device module

### æ¶æ§‹
æ”»æ“Šè¨­å‚™ç”±ä¸€å°Linuxç­†è¨˜æœ¬é›»è…¦å’Œä¸€å¡ŠCypress/Infineonçš„CYW20819æ¿é€šéUSBé€£æ¥è€Œæˆã€‚å…¶åˆå§‹åŒ–è¨­ç½®èˆ‡BIASå­˜å„²åº«ä¸­æè¿°çš„è¨­ç½®ç›¸åŒã€‚ç°¡è€Œè¨€ä¹‹ï¼Œç‚ºäº†å¾ç­†è¨˜æœ¬é›»è…¦çš„HCIæ¥å£è¨ªå•éˆè·¯å±¤æµé‡ï¼Œæˆ‘å€‘ä½¿ç”¨ä¾›æ‡‰å•†ç‰¹å®šçš„å‘½ä»¤å¾æ¿ä¸Šå•Ÿç”¨äº†LMPé‡å®šå‘ï¼Œä¸¦ä¿®è£œäº†ç­†è¨˜æœ¬é›»è…¦çš„Linuxå…§æ ¸ä»¥è§£æLMPæ•¸æ“šåŒ…ã€‚æ­¤å¤–ï¼Œæˆ‘å€‘ä½¿ç”¨Cypressçš„å°ˆæœ‰äºŒé€²åˆ¶å„€å™¨åŠŸèƒ½å°æ¿çš„å›ºä»¶é€²è¡Œäº†ä¿®è£œã€‚ä¿®è£œå›ºä»¶ï¼ˆè—ç‰™æ§åˆ¶å™¨ï¼‰å°æ–¼æ“ç¸±è—ç‰™é‡‘é‘°æ¨å°è‡³é—œé‡è¦ã€‚é€šéInternalblueï¼Œå¯ä»¥æ–¹ä¾¿åœ°å°æ¿é€²è¡Œä¿®è£œï¼Œè©²å·¥å…·æä¾›äº†é«˜ç´šPython APIä¾†å°æ¿é€²è¡Œä¿®è£œï¼ˆå³patchRomï¼‰ä»¥åŠè®€å–å’Œå¯«å…¥å…¶RAMï¼ˆå³readMemå’ŒwriteMemï¼‰ã€‚

CYW20819çš„ä¾›æ‡‰å•†ç‰¹å®šçš„ä¿®è£œæ©Ÿåˆ¶ç›¸ç•¶å¾©é›œä½†è°æ˜ã€‚é¦–å…ˆï¼Œå­˜å„²åœ¨åªè®€å­˜å„²å™¨ï¼ˆROMï¼‰ä¸­çš„æœªä¿®è£œå›ºä»¶æ¥æ”¶ä¾†è‡ªæˆ‘å€‘ç­†è¨˜æœ¬é›»è…¦ï¼ˆè—ç‰™ä¸»æ©Ÿï¼‰çš„Download_Minidriverå‘½ä»¤ä¸¦åœæ­¢åŸ·è¡Œã€‚ç„¶å¾Œï¼Œç­†è¨˜æœ¬é›»è…¦ç™¼é€Write_RAMå‘½ä»¤å°‡è¦åœ¨ROMä¸­ä¿®æ”¹çš„åœ°å€å¯«å…¥RAMã€‚æœ€å¾Œï¼Œç­†è¨˜æœ¬é›»è…¦é‹è¡ŒLaunch_RAMå‘½ä»¤å°‡ä¿®è£œç¨‹åºè¨»å†Šåˆ°RAMä¸¦æ¢å¾©åŸ·è¡Œã€‚å› æ­¤ï¼Œæ¯æ¬¡å›ºä»¶CPUæå–æ‡‰è©²ä¿®è£œçš„ROMä¸­çš„åœ°å€æ™‚ï¼Œæ§åˆ¶æµéƒ½æœƒè¢«é‡å®šå‘åˆ°RAMä¸­çš„ä¿®è£œç¨‹åºã€‚

> æ©Ÿåˆ¶ï¼š Jiska YouTube Channel. 2021. InternalBlue Tutorial - 2021 Edition. https://www.youtube.com/watch?v=UANnKx91vyg.

### Firmware patches
æˆ‘å€‘ç‚ºæ”»æ“Šè¨­å‚™çš„è—ç‰™å›ºä»¶é–‹ç™¼äº†ä¸ƒå€‹æ–°çš„ä¿®è£œç¨‹åºã€‚é€™äº›ä¿®è£œç¨‹åºæ‘˜è¦å¦‚è¡¨2æ‰€ç¤ºï¼Œå…è¨±åŸ·è¡Œç¬¬4ç¯€ä¸­ä»‹ç´¹çš„å…­ç¨®BLUFFSæ”»æ“Šã€‚è¡¨æ ¼çš„ç¬¬ä¸€å’Œç¬¬äºŒåˆ—é¡¯ç¤ºäº†ä¿®è£œç¨‹åºçš„åç¨±å’Œæè¿°ï¼Œè€Œæœ€å¾Œå…©åˆ—é¡¯ç¤ºäº†ä¿®è£œå¾Œçš„å›ºä»¶å‡½æ•¸åŠå…¶ROMåœ°å€ã€‚

æˆ‘å€‘çš„ä¿®è£œç¨‹åºç‚ºè—ç‰™æä¾›äº†æœ‰ç”¨çš„å®‰å…¨æ¸¬è©¦åŠŸèƒ½ã€‚
- ä¸‰å€‹`man_*`ä¿®è£œç¨‹åºæ“ç¸±ğ´ğ¶ã€ğ¶ğ‘…å’Œğ‘†ğ·ï¼Œä¸¦å…è¨±åƒåœ–2ä¸­ä¸€æ¨£å”å•†å›ºå®šçš„ğ‘†ğ¾åˆ†æ•£å™¨ï¼Œä¸¦åœ¨æ”»æ“Šè€…éœ€è¦å°ğ‘ƒğ¾é€²è¡Œèº«ä»½é©—è­‰æ™‚æ‹’çµ•æœƒè©±å»ºç«‹ã€‚
- ä¸‰å€‹`rea_*`ä¿®è£œç¨‹åºç›£æ§å¦å®šå°HCğ¼å’ŒLMPå±¤éš±è—çš„ğ‘†ğ¾çš„å€¼ã€‚
- `rs_nop`ä¿®è£œç¨‹åºå…è¨±æˆåŠŸæ”»æ“Šè¦æ±‚åˆ‡æ›åˆ°ä¸­å¿ƒçš„è¨­å‚™ï¼Œè€Œä¸ç®¡æ”»æ“Šè€…çš„åˆ‡æ›ç­–ç•¥å¦‚ä½•ã€‚è©²ä¿®è£œç¨‹åºéå¸¸æœ‰åƒ¹å€¼ï¼Œå› ç‚ºå®ƒå°‡æˆ‘å€‘æ”»æ“Šï¼ˆä»¥åŠBIAS+KNOBéˆï¼‰çš„æœ‰æ•ˆæ€§æ“´å±•åˆ°äº†ä¸€é¡æ–°çš„è¨­å‚™ã€‚ç ”ç©¶è€…é‡ç”¨äº†BIASå·¥å…·åŒ…ä¸­çš„ä¿®è£œç¨‹åºä¾†å”å•†ğ‘†ğ¸ = 7ï¼Œä»¥é€²è¡ŒKNOBæ”»æ“Šä¸¦é¿å…å°ğ‘ƒğ¾é€²è¡Œèº«ä»½é©—è­‰ã€‚é‚„ç·¨å¯«äº†ä¸€å€‹é«˜ç´šçš„ä¿®è£œç¨‹åºå‡½æ•¸ï¼Œä»¥ä¾¿æ–¼é–‹ç™¼æ–°çš„ä¿®è£œç¨‹åºï¼ˆè«‹åƒè¦‹device/patch.pyï¼‰ã€‚

é€šéé€†å‘å·¥ç¨‹ï¼ˆREï¼‰CYW20819è—ç‰™å›ºä»¶çš„æœªçŸ¥éƒ¨åˆ†ä¾†é–‹ç™¼è¡¨2ä¸­çš„ä¿®è£œç¨‹åºã€‚å…·é«”ä¾†èªªï¼Œä½¿ç”¨äº†Ghidra è¼‰å…¥äº†å¾Cypress SDKä¸­æ´©éœ²çš„å›ºä»¶ç¬¦è™Ÿï¼Œå¦‚æ‰€è¿°ã€‚ç”±æ–¼æˆ‘å€‘å°‡ä¿®è£œç¨‹åºå¯«æˆäº†ARM Thumb-2çµ„åˆèªè¨€ï¼Œå®ƒå€‘åŒ…å«äº†æŒ‰4å­—ç¯€é‚Šç•Œå°é½Šçš„2å­—ç¯€å’Œ4å­—ç¯€æŒ‡ä»¤ï¼Œä»£ç¢¼è·³è½‰åˆ°å¥‡åœ°å€ã€‚ç›®å‰ï¼Œç‚ºäº†ç¬¦åˆè² è²¬ä»»çš„æŠ«éœ²è¦æ±‚ï¼Œæˆ‘å€‘æ­£åœ¨ç™¼å¸ƒ`man_cr.s`ã€`rea_sk.s`å’Œ`rs_nop.s`ã€‚

Listing 1é¡¯ç¤ºäº†rs_nopä¿®è£œç¨‹åºï¼Œä»¥æ‹’çµ•å¤–åœè¨­å‚™çš„è§’è‰²åˆ‡æ›è«‹æ±‚ã€‚æ¯ç•¶å›ºä»¶ç¨‹åºè¨ˆæ•¸å™¨åœ¨ROMä¸­çš„handleLmpSwitchReqä¸­é”åˆ°0xA643Cæ™‚ï¼Œå›ºä»¶ä»£ç¢¼å°±æœƒè·³è½‰åˆ°æˆ‘å€‘åœ¨RAMä¸­çš„ä¿®è£œç¨‹åºã€‚ä¿®è£œç¨‹åºé€šéå°‡r1ç½®ç‚ºé›¶ï¼Œå°‡isMssInstantPassedçš„ç¬¬äºŒå€‹åƒæ•¸ä½œç‚ºé›¶å‚³éï¼Œç„¶å¾Œèª¿ç”¨ï¼ˆå³åˆ†æ”¯å’Œéˆæ¥ï¼‰isMssInstantPassedï¼Œä¸¦å°‡è©²ä¾‹ç¨‹çš„è¿”å›å€¼è¨­ç½®ç‚ºTrueï¼ˆå³å°‡r0è¨­ç½®ç‚º1ï¼‰ã€‚ä½œç‚ºå‰¯ä½œç”¨ï¼Œæ”»æ“Šè¨­å‚™å›ºä»¶èªç‚ºMSSï¼ˆæœ€å°å­äº‹ä»¶ç©ºé–“ï¼‰é–“éš”å·²ç¶“éå»ä¸¦æ‹’çµ•äº†å°æ‡‰çš„è§’è‰²åˆ‡æ›è«‹æ±‚ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œé€™ç¨®æ‹’çµ•ç¬¦åˆæ¨™æº–ã€‚æœ€å¾Œï¼Œä¿®è£œç¨‹åºç„¡æ¢ä»¶åœ°è·³å›åˆ°Thumb-2æ¨¡å¼ä¸‹çš„ä¸‹ä¸€å€‹æœ‰æ•ˆROMæŒ‡ä»¤ï¼ˆå³è·³è½‰åˆ°å¥‡åœ°å€ï¼‰ã€‚è©²ä¿®è£œç¨‹åºä½¿æˆ‘å€‘èƒ½å¤ åˆ©ç”¨ä¸€é¡æ–°çš„è¨­å‚™ï¼Œä¾‹å¦‚åœ¨æœƒè©±å»ºç«‹æœŸé–“è©¦åœ–ï¼ˆé˜²ç¦¦æ€§åœ°ï¼‰åˆ‡æ›åˆ°ä¸­å¿ƒè§’è‰²çš„å—å®³è€…ï¼Œæˆ‘å€‘å¯ä»¥æ‹’çµ•å…¶è§’è‰²åˆ‡æ›è«‹æ±‚ä»¥åˆ©ç”¨iPhone 12å’Œ13ã€‚

## Attack checker module
ç ”ç©¶è€…åšå‡ºçš„æ”»æ“Šæª¢æ¸¬å™¨ç‚ºè—ç‰™éœæ…‹åˆ†ææä¾›äº†æ–°çš„åŠŸèƒ½ã€‚çµ¦å®šä¸€å€‹åŒ…å«LMP( Link Manager Protocol)æ•¸æ“šåŒ…çš„pcapæ–‡ä»¶ï¼Œå®ƒæœƒè‡ªå‹•åˆ†é›¢è—ç‰™æœƒè©±ï¼Œè¨ˆç®—æœƒè©±å¯†é‘°ä¸¦æª¢æ¸¬BLUFFSæ”»æ“Šã€‚æˆ‘å€‘å°‡å…¶ä½œç‚ºæˆ‘å€‘BLUFFSå·¥å…·åŒ…çš„ä¸€éƒ¨åˆ†åœ¨æª¢æŸ¥å™¨æ–‡ä»¶å¤¾ä¸­ç™¼å¸ƒã€‚æª¢æŸ¥å™¨æ˜¯ä½¿ç”¨Python 3 ç·¨å¯«çš„ï¼Œåˆ©ç”¨äº†å¼·å¤§ä¸”å¯ç”¨çš„å·¥å…·ï¼Œå¦‚wireshark / tsharkã€pysharkã€‚

>pcapï¼ˆpacket captureï¼‰
>---
>- æ˜¯ä¸€ç¨®å¸¸è¦‹çš„ç¶²è·¯æ•¸æ“šåŒ…æ•ç²æ–‡ä»¶æ ¼å¼ï¼Œç”¨æ–¼å­˜å„²å¾ç¶²è·¯æ¥å£æ•ç²åˆ°çš„æ•¸æ“šåŒ…ã€‚
>- æœ‰å›ºå®šæ ¼å¼ï¼Œç›´æ¥ç”¨æ–‡å­—ç·¨è¼¯å™¨æ‰“é–‹å¯èƒ½æœƒæœ‰äº‚ç¢¼
>- æ¶æ§‹ç‚º ã€ŒPcap Headerã€ã€ã€ŒPacket  Header1ã€ã€ã€ŒPacket  Data1ã€ã€ã€ŒPacket  Header2ã€ã€ã€ŒPacket  Data2ã€â‹¯â‹¯
>æ›´å¤šç›¸é—œè³‡è¨Šï¼šhttps://www.solarwinds.com/resources/it-glossary/pcap

ä¸‹æ–¹ç‚º `checker/parser/py`ï¼Œä¸»è¦ç”¨æ–¼è§£æBluetoothé€šè¨Šä¸­çš„LMPï¼ˆLink Management Protocolï¼‰å°åŒ…ï¼Œä¸¦æª¢æŸ¥pcapæ–‡ä»¶æ˜¯å¦åŒ…å«æœ‰æ•ˆçš„è—ç‰™é€šè¨Šæ•¸æ“šã€‚

```python=
import pyshark
from pathlib import Path

from hwdb import HWDB
from lmp import LMP_OPCODES, LMP_OPCODES_EXT, LMP_VERSIONS, LMP_ERROR_CODES
from lmp import LMP_AUTH_REQS, LMP_TRANS_FLOW, LMP_TRANS_INIT, LMP_IO_CAPS
from lmp import LMP_CRYPTO_MODES, LMP_KEYSIZES
from lmp import LMP_ENRAND_LEN, LMP_AURAND_LEN, LMP_SRES_LEN


#check_pathå‡½æ•¸æ˜¯è² è²¬æª¢æŸ¥æ˜¯å¦åŒ…å«æœ‰æ•ˆçš„è—ç‰™é€šè¨Šæ•¸æ“šçš„ã€‚
def check_path(arg1: str) -> bool:
    """Check that arg1 is a valid pcap[ng] path.

    :arg1: str
    :returns: bool

    """
    path = Path(arg1) # æª¢æŸ¥å‚³å…¥çš„è·¯å¾‘æ˜¯å¦æŒ‡å‘ä¸€å€‹å­˜åœ¨çš„æª”æ¡ˆï¼Œä¸¦ä¸”æª”æ¡ˆçš„å‰¯æª”åæ˜¯.pcapæˆ–.pcapng
    is_path = False
    if path is None:
        print(f"check_path: {arg1} is None")
        is_path = False
    elif path.is_dir():
        print(f"check_path: {arg1} is a path to a folder")
        is_path = False
    elif path.is_file() and path.suffix in (".pcap", ".pcapng"):
        is_path = True
    elif not path.exists():
        print(f"check_path: {arg1} does not exist")
        is_path = False
    else:
        is_path = False
    return is_path

# å¾å‚³å…¥çš„å°åŒ…ä¸­å–å¾— LMPï¼ˆLink Manager Protocolï¼‰çš„ op codeï¼Œä¸¦ä¸”å°‡å…¶è½‰æ›ç‚ºæ•´æ•¸å‹åˆ¥å¾Œè¿”å›ã€‚
def get_opcode(packet: pyshark.packet.packet.Packet) -> int:
    """Return the LMP opcode"""
    return int(packet.h4bcm.btbrlmp_op)

# å…ˆå‘¼å« get_opcode å‡½å¼ä»¥å–å¾— LMP çš„ op codeï¼Œç„¶å¾Œæª¢æŸ¥é€™å€‹ op code æ˜¯å¦ç­‰æ–¼ 127ã€‚è‹¥æ¢ä»¶æˆç«‹ï¼Œå‰‡å¾å°åŒ…ä¸­å–å¾— LMP çš„æ“´å±• op codeï¼Œå°‡å…¶è½‰æ›ç‚ºæ•´æ•¸å‹åˆ¥å¾Œè¿”å›ã€‚
def get_opcode_ext(packet: pyshark.packet.packet.Packet) -> int:
    """Return the LMP opcode"""
    assert get_opcode(packet) == 127
    return int(packet.h4bcm.btbrlmp_eop)


# NOTE: Parent class
class LmpBase(object):
    """Base Class for LMP Parsing"""

    # æå–è—ç‰™å°åŒ…ä¸­çš„ä¸€äº›å±¬æ€§ï¼ˆå¦‚å°åŒ…è™Ÿç¢¼ã€å‚³è¼¸åˆå§‹åŒ–å€¼ã€å‚³è¼¸æµç¨‹ç­‰ï¼‰
    def __init__(self, packet: pyshark.packet.packet.Packet):
        # self.lenght = int(packet.length)
        self.number = int(packet.number)
        # self.sniff_time = packet.sniff_time  # datetime.datetime

        # h4bcm layer
        _tinit = int(packet.h4bcm.btbrlmp_tid)
        self.tinit = LMP_TRANS_INIT[_tinit]
        self.tflow = LMP_TRANS_FLOW[_tinit][int(packet.h4bcm.flow)]

        self.opcode = int(packet.h4bcm.btbrlmp_op)
        # NOTE: if the opcode is ex we use the ext LMP command string
        if self.opcode == 127:
            self.opcode_ext = int(packet.h4bcm.btbrlmp_eop)
            self.opcode_str = LMP_OPCODES_EXT[self.opcode_ext]
        else:
            self.opcode_str = LMP_OPCODES[self.opcode]

    def __repr__(self):
        return str(vars(self))


# NOTE: Specialized LMP classes
class LmpHostConnReq(LmpBase):
    """Parse LMP_host_connection_req"""

    def __init__(self, packet: pyshark.packet.packet.Packet):
        super().__init__(packet)


class LmpDetach(LmpBase):
    """Parse LMP_detach"""

    def __init__(self, packet: pyshark.packet.packet.Packet):
        super().__init__(packet)

        self.err = int(packet.h4bcm.btbrlmp_err, 16)
        self.err_str = LMP_ERROR_CODES[self.err]


class LmpAccepted(LmpBase):
    """Parse LMP_accepted"""

    def __init__(self, packet: pyshark.packet.packet.Packet):
        super().__init__(packet)

        self.in_resp_to = int(packet.h4bcm.btbrlmp_opinre)
        self.in_resp_to_str = LMP_OPCODES[self.in_resp_to]


class LmpNotAccepted(LmpBase):
    """Parse LMP_not_accepted"""

    def __init__(self, packet: pyshark.packet.packet.Packet):
        super().__init__(packet)

        self.in_resp_to = int(packet.h4bcm.btbrlmp_opinre)
        self.in_resp_to_str = LMP_OPCODES[self.in_resp_to]
        self.err = int(packet.h4bcm.btbrlmp_err, 16)
        self.err_str = LMP_ERROR_CODES[self.err]


class LmpAuRand(LmpBase):
    """Parse LMP_au_rand"""

    def __init__(self, packet: pyshark.packet.packet.Packet):
        super().__init__(packet)

        self.aurand = packet.h4bcm.btbrlmp_rand
        self.aurand_ba = bytearray.fromhex(self.aurand.replace(":", ""))
        assert len(self.aurand_ba) == LMP_AURAND_LEN


class LmpSres(LmpBase):
    """Parse LMP_sres"""

    def __init__(self, packet: pyshark.packet.packet.Packet):
        super().__init__(packet)

        self.sres = packet.h4bcm.btbrlmp_authres
        self.sres_ba = bytearray.fromhex(self.sres.replace(":", ""))
        assert len(self.sres_ba) == LMP_SRES_LEN


class LmpEncryptionKeySizeReq(LmpBase):
    """Parse LMP_encryption_key_size_req"""

    def __init__(self, packet: pyshark.packet.packet.Packet):
        super().__init__(packet)

        self.keysize = int(packet.h4bcm.btbrlmp_keysz)
        assert self.keysize in LMP_KEYSIZES


class LmpStartEncryptionReq(LmpBase):
    """Parse LMP_start_encryption_req"""

    def __init__(self, packet: pyshark.packet.packet.Packet):
        super().__init__(packet)

        # NOTE: enrand not used with SC
        self.enrand = packet.h4bcm.btbrlmp_rand
        self.enrand_ba = bytearray.fromhex(self.enrand.replace(":", ""))
        assert len(self.enrand_ba) == LMP_ENRAND_LEN
```
### è§£æå™¨
æª¢æŸ¥å™¨çš„è§£æå™¨ä½¿ç”¨pysharkå¾pcapæ–‡ä»¶ä¸­æå–ç›¸é—œçš„LMPæ•¸æ“šåŒ…ã€‚å¦‚è¡¨3æ‰€ç¤ºï¼Œå®ƒæ”¯æŒä¹ç¨®LMPæ•¸æ“šåŒ…é¡å‹ã€‚å…·é«”è€Œè¨€ï¼Œå®ƒè§£æLMP_host_connection_reqå’ŒLMP_detachæ•¸æ“šåŒ…ï¼Œé€™äº›æ•¸æ“šåŒ…æŒ‡ç¤ºæœƒè©±çš„é–‹å§‹å’ŒçµæŸã€‚å®ƒå¾LMP_en- cryption_key_size_reqå’Œç›¸é—œçš„LMP_acceptedæ•¸æ“šåŒ…ä¸­è™•ç†ç†µå”å•†å€¼ï¼ˆğ‘†ğ¸ï¼‰ã€‚è©²è§£æå™¨é‚„ç®¡ç†ä¾†è‡ªLMP_au_randå’ŒLMP_sresæ•¸æ“šåŒ…çš„èº«ä»½é©—è­‰æŒ‘æˆ°ï¼ˆğ´ğ¶ï¼‰å’ŒéŸ¿æ‡‰ï¼ˆğ¶ğ‘…ï¼‰ï¼Œä¸¦é€šéç›£è¦–ç›¸æ‡‰çš„LMP_not_acceptedæ•¸æ“šåŒ…æª¢æ¸¬ğ´ğ¶æ˜¯å¦è¢«æ¥å—ã€‚æ­¤å¤–ï¼Œå®ƒé€šéè§£æLMP_start_encryption_reqå’Œç›¸æ‡‰çš„LMP_acceptedæ•¸æ“šåŒ…ä¾†è™•ç†æœƒè©±å¯†é‘°åˆ†æ•£ï¼ˆğ‘†ğ·ï¼‰ã€‚

è§£æå™¨çš„å¯¦ç¾åœ¨device/parser.pyä¸­ï¼Œä¸¦éµå¾ªé¢å‘å°è±¡çš„è¨­è¨ˆã€‚å¦‚æ¸…å–®2æ‰€ç¤ºï¼ŒLmpBaseçˆ¶é¡è§£ææ‰€æœ‰LMPæ•¸æ“šåŒ…å…±äº«çš„ç›¸é—œå­—æ®µã€‚ä¾‹å¦‚ï¼Œå®ƒå­˜å„²äº†LMPæ•¸æ“šåŒ…è™Ÿï¼ˆnumberï¼‰ã€äº‹å‹™ç™¼èµ·è€…ï¼ˆtinitï¼‰å’Œæ“ä½œç¢¼ï¼ˆopã€op_extï¼‰ã€‚ç‰¹æ®ŠåŒ–çš„é¡ï¼Œæ“´å±•è‡ªLmpBaseï¼Œç®¡ç†ç‰¹å®šçš„LMPæ“ä½œç¢¼ã€‚ä¾‹å¦‚ï¼ŒLmpAuRandï¼Œåœ¨åˆ—è¡¨3ä¸­å±•ç¤ºï¼Œè™•ç†LMP_au_randæ•¸æ“šåŒ…ä¸¦å°‡ğ´ğ¶æå–ç‚ºåå…­é€²åˆ¶å­—ç¬¦ä¸²å’Œå­—ç¯€æ•¸çµ„ï¼ˆaurandå’Œaurand_baï¼‰ã€‚æˆ‘å€‘é–‹ç™¼äº†å¦å¤–å…«å€‹å°ˆç”¨çš„LMPé¡ï¼Œæ›´å¤šç´°ç¯€è«‹åƒè¦‹`parser.py`ã€‚

### KDF
kdf æ¨¡çµ„å¯¦ç¾äº†LSCå¯†é‘°æ´¾ç”Ÿå‡½æ•¸ï¼Œå¦‚åˆ—è¡¨4æ‰€ç¤ºã€‚é€™å€‹åŠŸèƒ½æ˜¯è‡ªå‹•è¨ˆç®—å’Œæª¢æŸ¥è·¨æœƒè©±çš„ğ‘†ğ¾æ‰€å¿…éœ€çš„ã€‚å…·é«”ä¾†èªªï¼Œ`kdf.py`é€šéä½¿ç”¨ `e1.py` ã€ `e3.py` å’Œ`es.py`åŠå…¶ç›¸é—œçš„åŠ å¯†åŸèªï¼ˆå¦‚`h.py`ï¼‰ä¾†è¨ˆç®—ğ‘†ğ¾ï¼ˆå¦‚æ–¹ç¨‹å¼1ä¸­æ‰€ç¤ºï¼‰ã€‚æˆ‘å€‘åœ¨å·¥å…·åŒ…çš„deviceæ–‡ä»¶å¤¾ä¸­æä¾›äº†kdfä»£ç¢¼ï¼Œä¸¦ä¸”æˆ‘å€‘æ³¨æ„åˆ°ï¼Œå®ƒé€šéæä¾›å®Œæ•´çš„LSCå¯†é‘°æ´¾ç”Ÿéˆä¾†æ“´å±•äº†ã€‚æˆ‘å€‘çš„ä»£ç¢¼æ˜¯æ­£ç¢ºçš„ï¼Œå› ç‚ºå®ƒå·²ç¶“æ ¹æ“šè—ç‰™æ¨™æº–ä¸­çš„å‘é‡å’Œæˆ‘å€‘å¯¦é©—æœŸé–“æå–çš„å¯¦éš›å€¼é€²è¡Œäº†æ¸¬è©¦ã€‚kdfæ¸¬è©¦å¥—ä»¶å¯ä»¥é€šéé‹è¡Œmake testsä¾†é‹è¡Œã€‚

### åˆ†æå™¨
åˆ†æå™¨æ¨¡çµ„æ˜¯åœ¨`checker/analyzer.py`ä¸­å¯¦ç¾çš„ï¼Œè‡ªå‹•æª¢æ¸¬BLUFFSæ”»æ“Šã€‚ å®ƒåŸºæ–¼ä¹‹å‰ä»‹ç´¹çš„è§£æå™¨å’Œkdfæ¨¡çµ„ï¼Œä½¿ç”¨gen_analysis()å‡½æ•¸ï¼Œè©²å‡½æ•¸çš„è¼¸å…¥æ˜¯ä¸€å€‹pcapæ–‡ä»¶ã€ä¸€å€‹ğ‘ƒğ¾å’Œå—å®³è€…ï¼ˆå‘¨é‚Šè¨­å‚™ï¼‰çš„è—ç‰™åœ°å€ã€‚ ç„¶å¾Œå®ƒèª¿ç”¨gen_sessionså¾pcapä¸­æå–ä¸€å€‹LMPæœƒè©±åˆ—è¡¨ï¼ˆsessionsï¼‰ã€‚å°æ–¼æ¯å€‹æœƒè©±ï¼Œå®ƒèª¿ç”¨gen_report()å‡½æ•¸å¾ğ‘†ğ¸ã€ğ‘†ğ·å’Œğ´ğ¶è¨ˆç®—ğ‘†ğ¾ï¼Œä¸¦å°‡å ±å‘Šå­˜å„²åœ¨åˆ—è¡¨ä¸­ï¼ˆreportsï¼‰ã€‚æœ€å¾Œï¼Œå°æ–¼æ¯å€‹å ±å‘Šï¼Œgen_analysisæª¢æŸ¥$ğ‘†ğ¾_ğ¶$æ˜¯å¦è·¨æœƒè©±é‡ç”¨ï¼ˆassert report["sk"] == EXP_SKï¼‰ã€‚ 

```python=
"""
analyzer.py

"""

from parser import LmpNotAccepted, LmpAccepted, LmpAuRand, LmpSres, get_opcode
from parser import LmpEncryptionKeySizeReq, LmpStartEncryptionReq

import pyshark

from lmp import LMP_OPCODES
from kdf import kdf

PK_BYTES = 16
BTADD_BYTES = 6
BTADD_DEVBOARD = bytearray.fromhex("20819A093E41")

BA_16_ZEROS = bytearray.fromhex("00000000000000000000000000000000")

# æª¢æŸ¥ä¸€å€‹è®Šæ•¸ pair_key æ˜¯å¦ç‚º PKï¼ˆPairing Keyï¼‰
def check_pk(pair_key: str) -> bool:
    """Check if PK is in valid format

    e.g., 5B61D2D4E4341878441883BB2055F2C9
    """
    try:
        assert len(pair_key) == PK_BYTES * 2 # ç¢ºä¿ pair_key çš„é•·åº¦ç¬¦åˆé æœŸçš„ PK é•·åº¦ã€‚
        assert int(pair_key, 16) # æ˜¯å¦å¯ä»¥æˆåŠŸè½‰æ›ç‚ºåå…­é€²ä½æ•¸å€¼ã€‚
        return True
    except (AssertionError, ValueError):
        print("check_pk ERROR")
        return False

# è—ç‰™åœ°å€
def check_btadd(btadd: str) -> bool:
    """Check if PK is in valid format

    e.g., 5B61D2D4E4341878441883BB2055F2C9
    """
    try:
        assert len(btadd) == BTADD_BYTES * 2
        assert int(btadd, 16)
        return True
    except (AssertionError, ValueError):
        print("check_btadd ERROR")
        return False


def gen_sessions(pcap_path: str) -> list:
    """Parse pcap and generate a list of sessions"""

    # NOTE: test first btlmp DF and then btbrlmp
    pkts = pyshark.FileCapture(pcap_path, display_filter="btlmp")
    pkts.load_packets()
    if len(pkts) == 0:
        print("DEBUG: No LMP packets with btlmp df, trying btbrlmp.")
        pkts = pyshark.FileCapture(pcap_path, display_filter="btbrlmp")
        pkts.load_packets()
    if len(pkts) == 0:
        print("DEBUG: No LMP packets found with bt[br]lmp df.")
    
        
    ses = [] # ses ä¾†å­˜æ”¾è§£æå¾Œçš„å°åŒ…è³‡æ–™
    ses_count = 0
    parse = False
    se = []
    # FIXME: ATM I'm not filtering out LMP pairing
    for pkt in pkts:
        opcode = get_opcode(pkt)
        # NOTE: new session  with LMP_host_connection_req
        if opcode == 51: # è‹¥ op code ç‚º 51ï¼ˆLMP_host_connection_reqï¼‰ï¼Œå‰‡é–‹å§‹ä¸€å€‹æ–°çš„æœƒè©±ï¼ˆsessionï¼‰
            ses_count += 1
            parse = True
            se = []
        # NOTE: end session  with LMP_detach
        elif opcode == 7:
            # NOTE: if LMP_detach is before LMP_host_connection_req
            try:
                ses.append(se)
            except UnboundLocalError:
                pass
            parse = False
        elif parse:
            if LMP_OPCODES[opcode] == "LMP_accepted":
                se.append(LmpAccepted(pkt))
            elif LMP_OPCODES[opcode] == "LMP_not_accepted":
                se.append(LmpNotAccepted(pkt))
            elif LMP_OPCODES[opcode] == "LMP_au_rand":
                se.append(LmpAuRand(pkt))
            elif LMP_OPCODES[opcode] == "LMP_sres":
                se.append(LmpSres(pkt))
            elif LMP_OPCODES[opcode] == "LMP_encryption_key_size_req":
                se.append(LmpEncryptionKeySizeReq(pkt))
            elif LMP_OPCODES[opcode] == "LMP_start_encryption_req":
                se.append(LmpStartEncryptionReq(pkt))
        else:
            continue

    pkts.close()
    return ses

# ä¸»è¦çš„å…¥å£å‡½æ•¸ï¼Œç”¨æ–¼ç”Ÿæˆæ‰€æœ‰è—ç‰™æœƒè©±çš„å®‰å…¨æ€§å ±å‘Šã€‚
def gen_report(session: list, pk: bytearray, btadd_p: bytearray) -> dict:
    """Generate a security report for an LSC session"""

    report = {}

    aurands = []
    found_keysize = False
    found_aurand = False
    found_enrand = False
    for pkt in session:
        if isinstance(pkt, LmpEncryptionKeySizeReq):
            if "keysize" not in report or report["keysize"] > pkt.keysize:
                report["keysize"] = pkt.keysize
                report["keysize_pnum"] = pkt.number
        elif isinstance(pkt, LmpAccepted) and pkt.in_resp_to == 16:
            report["keysize_accept_pnum"] = pkt.number
            assert report["keysize_pnum"] < report["keysize_accept_pnum"]
            found_keysize = True
        # NOTE: storing the last couple of AU_RAND-SRES
        elif isinstance(pkt, LmpAuRand):
            aurands.append(pkt.aurand_ba)
            found_aurand = True
        elif isinstance(pkt, LmpSres):
            report["sres"] = pkt.sres_ba
        elif isinstance(pkt, LmpStartEncryptionReq):
            report["enrand"] = pkt.enrand_ba
            found_enrand = True
        elif isinstance(pkt, LmpAccepted) and pkt.in_resp_to == 17:
            report["start_enc_accept_pnum"] = pkt.number
        # NOTE: remove last aurand if you get LMP_not_accepted 11
        elif isinstance(pkt, LmpNotAccepted) and pkt.in_resp_to == 11:
            aurands.pop(-1)

    # NOTE: manage multiple AURAND
    if found_aurand:
        report["aurand"] = aurands[-1]

    if found_aurand and found_enrand and found_keysize:
        report["sk"] = kdf(
            pk,
            report["aurand"],
            report["enrand"],
            btadd_p,
            report["keysize"],
        )

    return report


def gen_analysis(PCAP: str, LK: bytearray, EXP_SK: bytearray, BTADD_P: bytearray):
    """Generate list of sessions and reports"""

    sessions = gen_sessions(PCAP)

    reports = []
    for session in sessions:
        report = gen_report(session, LK, BTADD_P)
        reports.append(report)

    i = 1
    for report in reports:
        print(f"## Begin session: {i}")
        if "keysize" in report:
            print(f"keysize: {report['keysize']}")
        if "enrand" in report:
            print(f"enrand: {report['enrand'].hex()}")
        if "aurand" in report:
            print(f"aurand: {report['aurand'].hex()}")
        if "sk" in report:
            print(f"sk ses: {report['sk'].hex()}")
            # NOTE: check constant SK
            if report["aurand"] == BA_16_ZEROS and report["enrand"] == BA_16_ZEROS:
                print(f"sk exp: {EXP_SK.hex()}")
                assert report["sk"] == EXP_SK
        print(f"## End session: {i}\n")
        i += 1


def test_lsc_pixelbudsa():
    """test_lsc_pixelbudsa"""

    PCAP = "../pcap/lsc-pixelbuds-aseries.pcapng"
    LK = bytearray.fromhex("75fc7a5988b3529473858a10f947156a")
    BTADD_P = bytearray.fromhex("0CC413F76795")

    # NOTE: SK_C that we expect (see packet comment)
    EXP_SK = bytearray.fromhex("c61da2f42fefab75bb15b7927af0a631")

    print("# Pixel Buds A series, spoofed LSC victim")
    gen_analysis(PCAP, LK, EXP_SK, BTADD_P)
    print("")


def test_sc_pixelbudsa():
    """test_sc_pixelbudsa"""

    PCAP = "../pcap/sc-pixelbuds-aseries.pcapng"
    LK = bytearray.fromhex("07c508e25d92d9102ecddc0db62cb405")
    BTADD_P = bytearray.fromhex("0CC413F76795")

    # NOTE: SK_C that we expect (see packet comment)
    EXP_SK = bytearray.fromhex("3581f68eecc5d1f295894c6bc9262812")

    print("# Pixel Buds A series, spoofed SC victim")
    gen_analysis(PCAP, LK, EXP_SK, BTADD_P)
    print("")


if __name__ == "__main__":

    print("# NOTE")
    print("Ignore the first session as it is related to legitimate pairing")
    print("The attacker forces EXP_SK in all sessions")
    print("")
    test_lsc_pixelbudsa()
    test_sc_pixelbudsa()
```
# æå‡ LSC çš„å¯†é‘°è¡ç”Ÿå‡½æ•¸
ç ”ç©¶è€…æå‡ºçš„KDFä½¿ç”¨äº†èº«ä»½é©—è­‰å’Œç›¸äº’å¯†é‘°è¡ç”Ÿ(mutual key derivation)ï¼Œä¸¦èˆ‡$ğ¾ğ·ğ¹_{ğ¿ğ‘†ğ¶}$å…¼å®¹ã€‚æ­¤æ–¹æ³•ç¬¦åˆè—ç‰™æ¨™æº–ï¼ŒåŒæ™‚å¸¶ä¾†æœ€å°çš„è¨ˆç®—ã€ååé‡å’Œå»¶é²é–‹éŠ·ã€‚

## è¨­è¨ˆ
åœ–4åœ¨å››å€‹æ–¹é¢æ“´å±•äº†$KDF_{LSC}$ï¼Œå¦‚åœ–1æ‰€è¿°ï¼š

1. æ·»åŠ äº†ä¸€å€‹ç‰¹å¾µæ¨™èªŒğ¸ğ¾ğ·ï¼Œç”¨æ–¼å”å•†ç ”ç©¶è€…è¨­ç«‹çš„KDFï¼Œå¦‚åœ–4ä¸­çš„å‰å…©å€‹æ¶ˆæ¯æ‰€ç¤ºã€‚
    - æ­¤æ¨™èªŒæä¾›äº†å‘å¾Œå…¼å®¹æ€§ï¼Œå› ç‚ºå®ƒå¯ä»¥å®¹ç´æ”¯æŒå’Œä¸æ”¯æŒæˆ‘å€‘å”è­°çš„è¨­å‚™ã€‚
    - å¯ä»¥å¼·åˆ¶åœ¨æœƒè©±ä¹‹é–“ä½¿ç”¨æˆ‘å€‘çš„å”è­°ï¼Œé¿å…ï¼ˆæƒ¡æ„çš„ï¼‰KDFé™ç´šã€‚ç•¶Bluetoothå¼•å…¥SCæ™‚ï¼Œè©²æ¨™æº–æ¡ç”¨äº†ç›¸åŒçš„æ–¹æ³•ã€‚
2.  å°‡ğ‘†ğ·å®šç¾©ç‚ºä¸€æ¬¡æ€§ä½¿ç”¨çš„è™Ÿç¢¼ï¼ˆnonceï¼‰ï¼Œè€Œä¸æ˜¯ä½œç‚ºéš¨æ©Ÿæ•¸ã€‚é€™ç¨®å®šç¾©å¾ˆæœ‰åƒ¹å€¼ï¼Œå› ç‚ºå®ƒé€šéè¨­è¨ˆè¦æ±‚æ‹’çµ•é‡ç”¨ğ‘†ğ·ï¼Œç„¡è«–æ”»æ“Šè€…çš„ç­–ç•¥å¦‚ä½•ã€‚
3.  æ¡ç”¨äº†åœ–4ä¸­å‘ˆç¾çš„äº’ç›¸é©—è­‰çš„å¯†é‘°å¤šæ¨£åŒ–æ–¹æ¡ˆï¼Œè€Œä¸æ˜¯æ¨™æº–ä¸­çš„å–®æ–¹é¢å’Œæœªç¶“é©—è­‰çš„æ–¹æ¡ˆã€‚
    - Aliceå‘Bobç™¼é€$ğ‘†ğ·_ğ´$ï¼ˆå³ä¸­å¤®ğ‘†ğ· nonceï¼‰ï¼ŒBobå›è¦†$ğ‘€ğ‘ğ‘(ğ‘†ğ·_ğ´,ğ‘ƒğ¾)$ï¼Œé€™æ˜¯å¾å¤šæ¨£æ€§å™¨å’Œğ‘ƒğ¾è¨ˆç®—çš„æ¶ˆæ¯é©—è­‰ç¢¼ï¼ˆMACï¼‰ä»¥ç¢ºèªä¸¦é©—è­‰å®ƒã€‚
    - å¦‚æœMACæª¢æŸ¥å¤±æ•—ï¼ŒAliceæœƒä¸­æ­¢æœƒè©±ï¼Œè€ŒCharlieç„¡æ³•ç”Ÿæˆé€™æ¨£çš„MACï¼Œå› ç‚ºå¥¹ä¸çŸ¥é“ğ‘ƒğ¾ã€‚
    - å”è­°å¼·åˆ¶è¦æ±‚Bobå‘Aliceäº¤æ›é¡ä¼¼çš„æ¶ˆæ¯ï¼Œæ¶‰åŠ$ğ‘†ğ·_ğµ$ï¼ˆå³å¤–åœğ‘†ğ· nonceï¼‰å’Œ$ğ‘€ğ‘ğ‘(ğ‘†ğ·_ğµ,ğ‘ƒğ¾)$ã€‚åœ¨äº¤æ›é€™äº›æ¶ˆæ¯ä¹‹å¾Œï¼ŒAliceå’ŒBobç›¸äº’è¨­ç½®å’Œé©—è­‰æœƒè©±é‡‘é‘°å¤šæ¨£åŒ–å™¨ã€‚
4.  ä½¿ç”¨$ğ‘€ğ¾ğ·_{ğ¹ğ¿ğ‘†ğ¶}$ç›¸äº’å¯†é‘°è¡ç”Ÿå‡½æ•¸ä¾†è¨ˆç®—ç›¸äº’å¤šæ¨£åŒ–çš„ğ‘†ğ¾ï¼Œè€Œä¸åƒKDFLSCå…è¨±å–®ä¸€ï¼ˆæƒ¡æ„ï¼‰æ–¹å°ğ‘†ğ¾é€²è¡Œå¤šæ¨£åŒ–ã€‚ç‰¹åˆ¥æ˜¯ï¼Œ$ğ‘€ğ¾ğ·_{ğ¹ğ¿ğ‘†ğ¶}$å°‡ğ‘†ğ¾ç¶å®šåˆ°Aliceå’ŒBobç™¼é€çš„é©—è­‰éçš„nonceï¼Œå³$ğ‘†ğ·_ğ´$å’Œ$ğ‘†ğ·_ğµ$ã€‚

![æˆªåœ– 2024-04-19 ä¸‹åˆ3.31.37](https://hackmd.io/_uploads/rys1R9kWC.png =400x)


![æˆªåœ– 2024-04-19 ä¸‹åˆ3.22.32](https://hackmd.io/_uploads/Bk2Ai9yWR.png)

### ä½œæ³•è©³ç´°èªªæ˜
å¢å¼·çš„KDFä¿®å¾©äº†å…ˆå‰æå‡ºçš„å››å€‹æ”»æ“Šæ ¹æœ¬åŸå› ã€‚
- RC1:å¯†é‘°å¤šæ¨£åŒ–æ˜¯ç›¸äº’çš„ï¼Œå› ç‚ºğ‘†ğ¾å–æ±ºæ–¼ä¾†è‡ªä¸­å¤®å’Œå¤–åœçš„è²¢ç»ï¼ˆå³ğ‘†ğ·ğ´å’Œğ‘†ğ·ğµï¼‰ã€‚
- RC2:å¤šæ¨£åŒ–å™¨è¢«å®šç¾©ç‚ºnonceè€Œä¸æ˜¯éš¨æ©Ÿæ•¸ã€‚
- RC3:ä½¿ç”¨ä½¿ç”¨ğ‘ƒğ¾éµå…¥çš„æ¶ˆæ¯é©—è­‰ç¢¼ä¿è­·äº†å¤šæ¨£åŒ–å™¨çš„å”å•†ã€‚
- RC4:æˆ‘å€‘æä¾›äº†ä¸€ç¨®æ›´å¼·å¤§çš„LSCé‡‘é‘°æ¨å°å”è­°ï¼Œå®¹å¿ï¼ˆæƒ¡æ„çš„ï¼‰LSCåˆ°SCçš„é™ç´šã€‚

æ­¤æ–¹æ¡ˆé˜»æ­¢äº†å…­ç¨®BLUFFSæ”»æ“Šï¼Œç„¡è«–æ”»æ“Šè€…çš„è§’è‰²ï¼ˆCIï¼ŒPIæˆ–MitMï¼‰å’Œç›®æ¨™å®‰å…¨æ¨¡å¼ï¼ˆLSCæˆ–SCï¼‰ç‚ºä½•ã€‚ç‰¹åˆ¥æ˜¯ï¼Œåœ¨åœ–2ä¸­å‘ˆç¾çš„æ”»æ“Šç­–ç•¥è®Šå¾—ç„¡æ•ˆï¼Œå› ç‚ºå—å®³è€…è¦æ±‚å°æ–¹ä½¿ç”¨ğ‘ƒğ¾é©—è­‰ğ‘†ğ·ï¼Œå¦‚æœé©—è­‰å¤±æ•—ï¼Œå‰‡ä¸­æ­¢æœƒè©±å»ºç«‹ã€‚
æ­¤å¤–ï¼Œå³ä½¿æ”»æ“Šè€…æˆåŠŸé©—è­‰ï¼ˆä¾‹å¦‚ï¼Œé€šéç«Šå–ğ‘ƒğ¾ ï¼‰ï¼Œä¿®å¾©æªæ–½ä¹Ÿå¯ä»¥é˜²æ­¢æ”»æ“Šï¼Œå› ç‚ºæ”»æ“Šè€…ç„¡æ³•æ§åˆ¶å—å®³è€…çš„ğ‘†ğ· ä»¥å¼·åˆ¶ä½¿ç”¨å·²çŸ¥çš„ğ‘† ğ¾ ã€‚

å„˜ç®¡è¢«è¨­è¨ˆä¾†è§£æ±ºBLUFFSæ¼æ´ï¼Œæ­¤KDFä¹Ÿç·©è§£äº†KNOBæ”»æ“Šä¸¦é˜»æ­¢äº†BIASæ”»æ“Šã€‚ä½¿ç”¨é€™å€‹KDFï¼Œè‹¥æ”»æ“Šè€…è¦å°æ–°çš„ session æš´åŠ›ç ´è§£å‡ºå°æ‡‰æ–°çš„ SKï¼Œ ğ‘†ğ¾çš„æš´åŠ›ç ´è§£å·¥ä½œé‡éš¨è‘—è«‡åˆ¤ç†µçš„å¢åŠ å‘ˆæŒ‡æ•¸ç´šå¢åŠ ï¼Œéš¨è‘—ç›®æ¨™æœƒè©±æ•¸é‡çš„ç·šæ€§å¢åŠ ï¼Œå› ç‚ºæ”»æ“Šè€…å¿…é ˆç‚ºæ¯å€‹æœƒè©±é€²è¡Œæ–°çš„ğ‘†ğ¾æš´åŠ›ç ´è§£ï¼Œè€Œä¸æ˜¯ä¸€å€‹æœƒè©±çš„å–®å€‹ğ‘†ğ¾ã€‚

>e.g. å° ğ‘› å€‹æœƒè©±çš„æ”»æ“Šå·¥ä½œé‡å¾256å¢åŠ åˆ° ğ‘› Ã— 256ã€‚

æ­¤å¤–ï¼Œå®ƒé˜»æ­¢äº†BIASæ”»æ“Šï¼Œå› ç‚ºæˆåŠŸè·³éğ‘ƒğ¾é©—è­‰ï¼ˆä¾‹å¦‚ï¼Œé€šéæ”»æ“Šæœªä¿®è£œå°BIASçš„å—å®³è€…ï¼‰çš„å°æ‰‹ç„¡æ³•åœ¨ä¸çŸ¥é“ğ‘ƒğ¾çš„æƒ…æ³ä¸‹ç¹éæˆ‘å€‘çš„ç›¸äº’é©—è­‰é‡‘é‘°æ¨å°å”è­°ã€‚
